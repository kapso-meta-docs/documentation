openapi: 3.0.3
info:
  title: Kapso External API - WhatsApp API
  description:
    API for programmatically interacting with Kapso agents, executions,
    and WhatsApp conversations. This specification includes only WhatsApp API endpoints.
  version: 1.0.0
  contact:
    name: Kapso Support
servers:
  - url: https://app.kapso.ai/api/v1
    description: Production server
components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key required for all endpoints
  schemas:
    WhatsappTemplate:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: template-123abc
        name:
          type: string
          example: appointment_reminder
        language_code:
          type: string
          example: en_US
        category:
          type: string
          enum:
            - MARKETING
            - UTILITY
            - AUTHENTICATION
          example: UTILITY
        status:
          type: string
          enum:
            - draft
            - submitted
            - approved
            - rejected
            - disabled
            - removed
          example: approved
        content:
          type: string
          example: Hello {{1}}, your appointment is confirmed for {{2}}.
        parameter_count:
          type: integer
          example: 2
        business_account_id:
          type: string
          nullable: true
          example: "123456789012345"
          description: WhatsApp Business Account ID this template belongs to
        whatsapp_config_ids:
          type: array
          items:
            type: string
            format: uuid
          example: ["config-123abc", "config-456def"]
          description: Array of WhatsApp config IDs this template is associated with
        components:
          type: array
          description: Raw WhatsApp template components structure
          items:
            type: object
            properties:
              type:
                type: string
                enum: [HEADER, BODY, FOOTER, BUTTONS]
              format:
                type: string
                enum: [TEXT, IMAGE, VIDEO, DOCUMENT, LOCATION]
              text:
                type: string
              example:
                type: object
              buttons:
                type: array
                items:
                  type: object
        metadata:
          type: object
          description: Additional metadata about the template
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    Agent:
      type: object
      properties:
        id:
          type: string
          example: agent-123abc
        name:
          type: string
          example: Customer Support Agent
        description:
          type: string
          example: Handles initial customer support queries
        project_id:
          type: string
          example: project-456def
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    
    AgentExecution:
      type: object
      properties:
        id:
          type: string
          example: execution-789ghi
        agent_id:
          type: string
          example: agent-123abc
        thread_id:
          type: string
          example: thread-101jkl
        status:
          type: string
          enum:
            - started
            - running
            - paused
            - ended
            - handoff
          example: running
        started_at:
          type: string
          format: date-time
        ended_at:
          type: string
          format: date-time
          nullable: true
        duration:
          type: integer
          description: Duration in seconds
          nullable: true
    WhatsappConversation:
      type: object
      properties:
        id:
          type: string
          example: conversation-202mno
        phone_number:
          type: string
          example: "+1234567890"
        status:
          type: string
          enum:
            - active
            - ended
          example: active
        last_active_at:
          type: string
          format: date-time
        contact_name:
          type: string
          example: John Doe
        whatsapp_config_id:
          type: string
          format: uuid
          example: config-123abc
          description: ID of the WhatsApp configuration this conversation belongs to
    WhatsappContact:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: contact-789ghi
        wa_id:
          type: string
          example: "1234567890"
          description: The WhatsApp ID (normalized phone number)
        profile_name:
          type: string
          example: John Doe
          description: The contact's profile name from WhatsApp
        customer_id:
          type: string
          format: uuid
          nullable: true
          example: customer-456def
          description: ID of the associated customer, null for sandbox contacts
        metadata:
          type: object
          description: Additional metadata about the contact
          example:
            source: website
            tags:
              - lead
              - priority
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    WhatsappContactNote:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: note-123abc
        name:
          type: string
          nullable: true
          example: Customer Preference
          description: Optional name for the note
        content:
          type: string
          example: Prefers morning deliveries between 9-11 AM
          description: The content of the note
        metadata:
          type: object
          description: Additional metadata about the note
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    WhatsappMessage:
      type: object
      properties:
        id:
          type: string
          format: uuid
        phone_number:
          type: string
        message_type:
          type: string
          enum:
            - text
            - image
            - video
            - audio
            - document
            - template
            - location
            - interactive
            - reaction
            - contacts
          description: The type of WhatsApp message
        content:
          type: string
          description: Human-readable representation of the message content
        direction:
          type: string
          enum:
            - inbound
            - outbound
        status:
          type: string
        processing_status:
          type: string
          enum:
            - pending
            - processed
        whatsapp_message_id:
          type: string
        metadata:
          type: object
          nullable: false
          description: Type-specific metadata for the message
        media_url:
          type: string
          description:
            URL to access any attached media (for image, video, audio,
            document message types)
        message_type_data:
          type: object
          description: Type-specific data based on the message_type
          oneOf:
            - $ref: "#/components/schemas/TextMessageData"
            - $ref: "#/components/schemas/ImageMessageData"
            - $ref: "#/components/schemas/VideoMessageData"
            - $ref: "#/components/schemas/AudioMessageData"
            - $ref: "#/components/schemas/DocumentMessageData"
            - $ref: "#/components/schemas/LocationMessageData"
            - $ref: "#/components/schemas/TemplateMessageData"
            - $ref: "#/components/schemas/InteractiveMessageData"
            - $ref: "#/components/schemas/ReactionMessageData"
            - $ref: "#/components/schemas/ContactsMessageData"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    TextMessageData:
      type: object
      description: Data specific to text messages
      properties:
        text:
          type: string
          description: The text content of the message
    ImageMessageData:
      type: object
      description: Data specific to image messages
      properties:
        caption:
          type: string
          description: Optional caption for the image
        media_id:
          type: string
          description: WhatsApp media ID for the image
        mime_type:
          type: string
          description: MIME type of the image (e.g., image/jpeg)
    VideoMessageData:
      type: object
      description: Data specific to video messages
      properties:
        caption:
          type: string
          description: Optional caption for the video
        media_id:
          type: string
          description: WhatsApp media ID for the video
        mime_type:
          type: string
          description: MIME type of the video (e.g., video/mp4)
    AudioMessageData:
      type: object
      description: Data specific to audio messages
      properties:
        media_id:
          type: string
          description: WhatsApp media ID for the audio
        mime_type:
          type: string
          description: MIME type of the audio (e.g., audio/ogg)
    DocumentMessageData:
      type: object
      description: Data specific to document messages
      properties:
        caption:
          type: string
          description: Optional caption for the document
        media_id:
          type: string
          description: WhatsApp media ID for the document
        mime_type:
          type: string
          description: MIME type of the document (e.g., application/pdf)
        filename:
          type: string
          description: Original filename of the document
    LocationMessageData:
      type: object
      description: Data specific to location messages
      properties:
        latitude:
          type: number
          format: float
          description: Latitude coordinate
        longitude:
          type: number
          format: float
          description: Longitude coordinate
        location_name:
          type: string
          description: Optional name for the location
        location_address:
          type: string
          description: Optional address for the location
    TemplateMessageData:
      type: object
      description: Data specific to template messages
      properties:
        template_name:
          type: string
          description: Name of the template used
        template_language:
          type: string
          description: Language code of the template (e.g., en_US)
        template_params:
          type: array
          description: Parameters used in the template
          items:
            type: string
        header_type:
          type: string
          description: Type of header used in the template
          enum:
            - text
            - image
            - video
            - document
        header_params:
          type: string
          description: Content for the template header
        header_filename:
          type: string
          description: Filename for document headers
    InteractiveMessageData:
      type: object
      description: Data specific to interactive messages
      properties:
        interactive_type:
          type: string
          enum:
            - button
            - list
          description: Type of interactive message
        body_text:
          type: string
          description: Main text content of the interactive message
        header_text:
          type: string
          description: Optional header text
        footer_text:
          type: string
          description: Optional footer text
        buttons:
          type: array
          description: Buttons for button-type interactive messages
          items:
            type: object
            properties:
              id:
                type: string
                description: Unique identifier for the button
              title:
                type: string
                description: Display text for the button
        sections:
          type: array
          description: Sections for list-type interactive messages
          items:
            type: object
            properties:
              title:
                type: string
                description: Section title
              rows:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                      description: Row identifier
                    title:
                      type: string
                      description: Row title
                    description:
                      type: string
                      description: Optional row description
        reply_option_id:
          type: string
          description: For replies, the ID of the selected option
        reply_option_title:
          type: string
          description: For replies, the title of the selected option
        list_button_text:
          type: string
          description: Text for the button that opens the list (for list-type messages)
    ReactionMessageData:
      type: object
      description: Data specific to reaction messages
      properties:
        reaction_emoji:
          type: string
          description: Emoji used for the reaction
        reacted_to_message_id:
          type: string
          description: ID of the message being reacted to
    ContactsMessageData:
      type: object
      description: |
        Data specific to contact messages. Supports 1-257 contacts per WhatsApp guidelines.
        At least one contact with a name (formatted_name or first_name) is required.
      properties:
        contacts:
          type: array
          minItems: 1
          maxItems: 257
          description: List of contact cards to send
          items:
            type: object
            required:
              - name
            properties:
              name:
                type: object
                description: Contact name information. Either formatted_name or first_name is required.
                properties:
                  formatted_name:
                    type: string
                    description: Full formatted contact name
                    example: "Barbara J. Johnson"
                  first_name:
                    type: string
                    description: First name
                    example: "Barbara"
                  last_name:
                    type: string
                    description: Last name
                    example: "Johnson"
                  middle_name:
                    type: string
                    description: Middle name
                    example: "Joana"
                  prefix:
                    type: string
                    description: Name prefix
                    example: "Dr."
                  suffix:
                    type: string
                    description: Name suffix
                    example: "Esq."
              birthday:
                type: string
                format: date
                description: Contact birthday in YYYY-MM-DD format
                example: "1999-01-23"
              phones:
                type: array
                description: List of phone numbers
                items:
                  type: object
                  required:
                    - phone
                  properties:
                    phone:
                      type: string
                      description: Phone number (international format recommended)
                      example: "+16505559999"
                    type:
                      type: string
                      description: Phone number type
                      example: "Mobile"
                    wa_id:
                      type: string
                      description: WhatsApp ID (normalized phone number without + prefix)
                      example: "19175559999"
              emails:
                type: array
                description: List of email addresses
                items:
                  type: object
                  required:
                    - email
                  properties:
                    email:
                      type: string
                      format: email
                      description: Email address
                      example: "bjohnson@luckyshrub.com"
                    type:
                      type: string
                      description: Email type
                      example: "Work"
              addresses:
                type: array
                description: List of physical addresses
                items:
                  type: object
                  properties:
                    street:
                      type: string
                      description: Street address
                      example: "1 Lucky Shrub Way"
                    city:
                      type: string
                      description: City
                      example: "Menlo Park"
                    state:
                      type: string
                      description: State or province
                      example: "CA"
                    zip:
                      type: string
                      description: ZIP or postal code
                      example: "94025"
                    country:
                      type: string
                      description: Country name
                      example: "United States"
                    country_code:
                      type: string
                      description: ISO country code
                      example: "US"
                    type:
                      type: string
                      description: Address type
                      example: "Office"
              urls:
                type: array
                description: List of URLs
                items:
                  type: object
                  required:
                    - url
                  properties:
                    url:
                      type: string
                      format: uri
                      description: URL
                      example: "https://www.luckyshrub.com"
                    type:
                      type: string
                      description: URL type
                      example: "Company"
              org:
                type: object
                description: Organization information
                properties:
                  company:
                    type: string
                    description: Company name
                    example: "Lucky Shrub"
                  department:
                    type: string
                    description: Department name
                    example: "Legal"
                  title:
                    type: string
                    description: Job title
                    example: "Lead Counsel"
    WhatsappConversationAgentExecution:
      type: object
      properties:
        id:
          type: string
          format: uuid
        active:
          type: boolean
        handoff_reason:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        agent_execution:
          $ref: "#/components/schemas/AgentExecution"
    Error:
      type: object
      properties:
        error:
          type: string
          example: Resource not found
        status:
          type: integer
          example: 404
        message:
          type: string
          example: The requested resource could not be found
    WhatsappConfig:
      type: object
      description: |
        WhatsApp configuration resource returned by the External API.
        Sensitive write-only fields like `webhook_verify_token`, `webhook_destination_url`,
        and `access_token` are intentionally omitted from responses.
      properties:
        id:
          type: string
          example: config-123abc
        name:
          type: string
          example: Client WhatsApp
        display_name:
          type: string
          example: Client WhatsApp (+1234567890)
        phone_number_id:
          type: string
          example: "1234567890"
        business_account_id:
          type: string
          example: "98765432109"
        kind:
          type: string
          enum:
            - production
            - sandbox
          example: production
          description: Configuration environment type
        display_phone_number:
          type: string
          example: "+56 9 61461262"
          description: Formatted phone number for display purposes
        display_phone_number_normalized:
          type: string
          example: "56961461262"
          description: Normalized phone number without + prefix
        is_coexistence:
          type: boolean
          description: Indicates whether coexistence mode is enabled for this phone number
        webhook_verified_at:
          type: string
          format: date-time
          nullable: true
          description: Timestamp of the last successful webhook verification
        customer_id:
          type: string
          format: uuid
          example: customer-456def
        inbound_processing_enabled:
          type: boolean
          example: true
          description: Whether inbound message processing is enabled for this configuration
        calls_enabled:
          type: boolean
          example: false
          description: Whether voice calling is enabled for this configuration
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    WhatsappCall:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: call-123abc
        project_id:
          type: string
          format: uuid
          example: project-456def
        whatsapp_config_id:
          type: string
          format: uuid
          example: config-789ghi
        config_display_name:
          type: string
          example: Customer Support Line
          description: Display name of the WhatsApp configuration
        config_display_phone_number:
          type: string
          example: "+1234567890"
          description: Display phone number of the WhatsApp configuration
        voice_agent_id:
          type: string
          format: uuid
          nullable: true
          example: agent-101jkl
        voice_agent_name:
          type: string
          nullable: true
          example: Support Agent
          description: Name of the voice agent handling the call
        call_id:
          type: string
          example: wa-call-xyz123
          description: WhatsApp call identifier
        direction:
          type: string
          enum:
            - inbound
            - outbound
          example: inbound
          description: Call direction
        status:
          type: string
          example: completed
          description: Current status of the call
        duration_seconds:
          type: integer
          nullable: true
          example: 180
          description: Duration of the call in seconds
        started_at:
          type: string
          format: date-time
          nullable: true
          description: When the call started
        ended_at:
          type: string
          format: date-time
          nullable: true
          description: When the call ended
        session_started_at:
          type: string
          format: date-time
          nullable: true
          description: When the session started
        user_wa_id:
          type: string
          example: "1234567890"
          description: WhatsApp ID of the user
        whatsapp_contact_id:
          type: string
          format: uuid
          nullable: true
          example: contact-202mno
        whatsapp_conversation_id:
          type: string
          format: uuid
          nullable: true
          example: conversation-303pqr
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    WhatsappContactCallPermission:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: permission-123abc
        whatsapp_contact_id:
          type: string
          format: uuid
          example: contact-456def
        whatsapp_config_id:
          type: string
          format: uuid
          example: config-789ghi
        config_display_name:
          type: string
          example: Customer Support Line
          description: Display name of the WhatsApp configuration
        status:
          type: string
          enum:
            - accepted
            - rejected
          example: accepted
          description: Permission status
        source:
          type: string
          nullable: true
          example: api
          description: Source of the permission
        expires_at:
          type: string
          format: date-time
          nullable: true
          description: When the permission expires
        last_event_message_id:
          type: string
          nullable: true
          description: ID of the last event message
        last_event_at:
          type: string
          format: date-time
          nullable: true
          description: When the last event occurred
        allowed:
          type: boolean
          example: true
          description: Whether calls are currently allowed (considers expiration)
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    ConversationAssignment:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        active:
          type: boolean
        notes:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        created_by_user_id:
          type: string
          format: uuid
          nullable: true
    WhatsappWebhook:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: webhook-123abc
        url:
          type: string
          format: uri
          example: https://example.com/webhook
        secret_key:
          type: string
          example: your-secret-key
          description: Secret key for webhook signature verification
        events:
          type: array
          items:
            type: string
          example: ["messages", "status_updates", "templates"]
          description: List of events this webhook should receive
        active:
          type: boolean
          example: true
          description: Whether this webhook is active
        headers:
          type: object
          additionalProperties:
            type: string
          nullable: true
          example:
            X-Custom-Header: custom-value
          description: Custom headers to include in webhook requests
        buffer_enabled:
          type: boolean
          example: false
          description: Whether message buffering is enabled for batch delivery
        buffer_window_seconds:
          type: integer
          minimum: 1
          maximum: 60
          example: 5
          description: Time window in seconds to buffer messages before sending as batch
        max_buffer_size:
          type: integer
          minimum: 1
          maximum: 100
          example: 50
          description: Maximum number of messages to include in a single batch
        buffer_events:
          type: array
          items:
            type: string
          example: ["whatsapp.message.received"]
          description: List of events that should be buffered (currently only supports whatsapp.message.received)
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    WhatsappTemplateSyncRun:
      type: object
      description: Represents a WhatsApp template synchronization request grouped by Business Account
      properties:
        id:
          type: string
          format: uuid
          example: sync-run-123abc
          description: Unique identifier for the sync run
        business_account_id:
          type: string
          example: "123456789012345"
          description: WhatsApp Business Account ID this sync is for
        anchor_whatsapp_config_id:
          type: string
          format: uuid
          example: config-123abc
          description: Primary WhatsApp config ID used for this sync operation
        status:
          type: string
          enum:
            - queued
            - running
            - succeeded
            - failed
          example: running
          description: Current status of the sync operation
        templates_synced:
          type: integer
          example: 15
          description: Total number of templates synchronized
        templates_created:
          type: integer
          example: 5
          description: Number of new templates created during sync
        templates_updated:
          type: integer
          example: 10
          description: Number of existing templates updated during sync
        templates_removed:
          type: integer
          example: 2
          description: Number of templates removed during sync
        queued_at:
          type: string
          format: date-time
          example: "2024-01-15T10:00:00Z"
          description: When the sync was queued
        started_at:
          type: string
          format: date-time
          nullable: true
          example: "2024-01-15T10:01:00Z"
          description: When the sync started processing
        finished_at:
          type: string
          format: date-time
          nullable: true
          example: "2024-01-15T10:05:00Z"
          description: When the sync completed (success or failure)
        job_id:
          type: string
          nullable: true
          example: job-456def
          description: Background job ID for this sync operation
        error_class:
          type: string
          nullable: true
          example: WhatsappApiError
          description: Error class if sync failed
        error_message:
          type: string
          nullable: true
          example: Invalid access token
          description: Error message if sync failed
        results:
          type: object
          description: Detailed results per WhatsApp config ID
          additionalProperties:
            type: object
            properties:
              templates_synced:
                type: integer
              templates_created:
                type: integer
              templates_updated:
                type: integer
              templates_removed:
                type: integer
          example:
            config-123abc:
              templates_synced: 8
              templates_created: 3
              templates_updated: 4
              templates_removed: 1
            config-456def:
              templates_synced: 7
              templates_created: 2
              templates_updated: 4
              templates_removed: 1
        affected_whatsapp_config_ids:
          type: array
          items:
            type: string
            format: uuid
          example: ["config-123abc", "config-456def"]
          description: List of WhatsApp config IDs affected by this sync
        anchor_whatsapp_config:
          $ref: "#/components/schemas/WhatsappConfig"
          description: The WhatsApp configuration used as anchor for this sync
    PaginationMeta:
      type: object
      properties:
        page:
          type: integer
          example: 1
        per_page:
          type: integer
          example: 20
        total_pages:
          type: integer
          example: 5
        total_count:
          type: integer
          example: 100
security:
  - ApiKeyAuth: []
paths:
  /whatsapp_conversations:
    get:
      summary: List WhatsApp conversations
      description: Returns a list of WhatsApp conversations
      operationId: listWhatsappConversations
      tags:
        - WhatsApp Conversations
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: q[status_eq]
          in: query
          description: Filter by exact status match
          schema:
            type: string
            enum:
              - active
              - ended
        - name: q[last_active_at_gteq]
          in: query
          description: Filter by last_active_at greater than or equal to (ISO 8601 format)
          schema:
            type: string
            format: date-time
        - name: q[last_active_at_lteq]
          in: query
          description: Filter by last_active_at less than or equal to (ISO 8601 format)
          schema:
            type: string
            format: date-time
        - name: q[whatsapp_config_id_eq]
          in: query
          description: Filter by exact whatsapp_config_id match
          schema:
            type: string
            format: uuid
        - name: q[whatsapp_config_customer_id_eq]
          in: query
          description: Filter by customer_id through whatsapp_config relationship
          schema:
            type: string
            format: uuid
        - name: q[phone_number_eq]
          in: query
          description: Filter by exact phone number match (automatically normalized)
          schema:
            type: string
          example: "+1234567890"
      responses:
        "200":
          description: A list of WhatsApp conversations
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/WhatsappConversation"
                  meta:
                    type: object
                    properties:
                      page:
                        type: integer
                      per_page:
                        type: integer
                      total_pages:
                        type: integer
                      total_count:
                        type: integer
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /whatsapp_conversations/{conversation_id}:
    get:
      summary: Get WhatsApp conversation details
      description: Returns details for a specific WhatsApp conversation
      operationId: getWhatsappConversation
      tags:
        - WhatsApp Conversations
      parameters:
        - name: conversation_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: WhatsApp conversation details
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/WhatsappConversation"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    patch:
      summary: Update WhatsApp conversation status
      description: Updates the status of a specific WhatsApp conversation
      operationId: updateWhatsappConversation
      tags:
        - WhatsApp Conversations
      parameters:
        - name: conversation_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - whatsapp_conversation
              properties:
                whatsapp_conversation:
                  type: object
                  required:
                    - status
                  properties:
                    status:
                      type: string
                      enum:
                        - active
                        - ended
                      description: The new status for the conversation
                      example: ended
      responses:
        "200":
          description: WhatsApp conversation updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/WhatsappConversation"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /whatsapp_conversations/{conversation_id}/whatsapp_messages:
    get:
      summary: List messages in a WhatsApp conversation
      description: Returns a list of messages for a specific WhatsApp conversation
      operationId: listWhatsappMessages
      tags:
        - WhatsApp Messages
      parameters:
        - name: conversation_id
          in: path
          required: true
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        "200":
          description: A list of WhatsApp messages
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/WhatsappMessage"
                  meta:
                    type: object
                    properties:
                      page:
                        type: integer
                      per_page:
                        type: integer
                      total_pages:
                        type: integer
                      total_count:
                        type: integer
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      summary: Send a new WhatsApp message
      description:
        Sends a new message through WhatsApp Cloud API and creates the
        message record
      operationId: createWhatsappMessage
      tags:
        - WhatsApp Messages
      parameters:
        - name: conversation_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - message
              properties:
                message:
                  type: object
                  required:
                    - content
                  properties:
                    content:
                      type: string
                      description: The message content to send
                      example: Hello, how can I help you today?
                    message_type:
                      type: string
                      description: The type of message
                      enum:
                        - text
                        - image
                        - video
                        - audio
                        - document
                        - template
                        - location
                        - interactive
                        - reaction
                        - contacts
                      default: text
                      example: text
                    # Media message fields
                    media_url:
                      type: string
                      description: URL of the media file (required for image/video/audio/document)
                      example: "https://example.com/image.jpg"
                    caption:
                      type: string
                      description: Caption for media messages
                      example: "Check out this image"
                    filename:
                      type: string
                      description: Filename for document messages
                      example: "document.pdf"
                    # Location message fields
                    latitude:
                      type: number
                      format: float
                      description: Latitude (required for location messages)
                      example: 37.7749
                    longitude:
                      type: number
                      format: float
                      description: Longitude (required for location messages)
                      example: -122.4194
                    location_name:
                      type: string
                      description: Location name
                      example: "San Francisco"
                    # Template message fields
                    template_name:
                      type: string
                      description: Template name (required for template messages)
                      example: "hello_world"
                    template_language:
                      type: string
                      description: Template language code (required for template messages)
                      example: "en_US"
                    template_params:
                      type: array
                      description: Template parameters
                      items:
                        type: string
                      example: ["John", "Smith"]
                    # Interactive message fields
                    interactive_type:
                      type: string
                      enum: [button, list]
                      description: Interactive message type
                      example: "button"
                    body_text:
                      type: string
                      description: Interactive message body
                      example: "Choose an option"
                    buttons:
                      type: array
                      description: Buttons for interactive messages
                      items:
                        type: object
                        properties:
                          id:
                            type: string
                            example: "btn_1"
                          title:
                            type: string
                            example: "Yes"
                    # Contact message fields
                    contacts:
                      type: array
                      minItems: 1
                      maxItems: 257
                      description: |
                        Contact cards to send (required for contacts messages, 1-257 per WhatsApp guidelines).
                        At least one contact with a name is required.
                        Supports both nested name object and flattened name keys for backward compatibility.
                      items:
                        type: object
                        required:
                          - name
                        properties:
                          name:
                            type: object
                            description: Contact name (either formatted_name or first_name required)
                            properties:
                              formatted_name:
                                type: string
                                example: "Barbara J. Johnson"
                              first_name:
                                type: string
                                example: "Barbara"
                              last_name:
                                type: string
                                example: "Johnson"
                              middle_name:
                                type: string
                                example: "Joana"
                              prefix:
                                type: string
                                example: "Dr."
                              suffix:
                                type: string
                                example: "Esq."
                          birthday:
                            type: string
                            format: date
                            description: Contact birthday (YYYY-MM-DD)
                            example: "1999-01-23"
                          addresses:
                            type: array
                            items:
                              type: object
                              properties:
                                street:
                                  type: string
                                  example: "1 Lucky Shrub Way"
                                city:
                                  type: string
                                  example: "Menlo Park"
                                state:
                                  type: string
                                  example: "CA"
                                zip:
                                  type: string
                                  example: "94025"
                                country:
                                  type: string
                                  example: "United States"
                                country_code:
                                  type: string
                                  example: "US"
                                type:
                                  type: string
                                  example: "Office"
                          emails:
                            type: array
                            items:
                              type: object
                              required:
                                - email
                              properties:
                                email:
                                  type: string
                                  format: email
                                  example: "bjohnson@luckyshrub.com"
                                type:
                                  type: string
                                  example: "Work"
                          phones:
                            type: array
                            items:
                              type: object
                              required:
                                - phone
                              properties:
                                phone:
                                  type: string
                                  example: "+16505559999"
                                type:
                                  type: string
                                  example: "Landline"
                                wa_id:
                                  type: string
                                  example: "19175559999"
                          org:
                            type: object
                            properties:
                              company:
                                type: string
                                example: "Lucky Shrub"
                              department:
                                type: string
                                example: "Legal"
                              title:
                                type: string
                                example: "Lead Counsel"
                          urls:
                            type: array
                            items:
                              type: object
                              required:
                                - url
                              properties:
                                url:
                                  type: string
                                  format: uri
                                  example: "https://www.luckyshrub.com"
                                type:
                                  type: string
                                  example: "Company"
            examples:
              text_message:
                summary: Simple text message
                value:
                  message:
                    content: "Hello, how can I help you today?"
                    message_type: "text"
              image_message:
                summary: Image message
                value:
                  message:
                    content: "Check out this image"
                    message_type: "image"
                    media_url: "https://example.com/image.jpg"
                    caption: "Beautiful sunset"
              location_message:
                summary: Location message
                value:
                  message:
                    content: "Here's my location"
                    message_type: "location"
                    latitude: 37.7749
                    longitude: -122.4194
                    location_name: "San Francisco"
              template_message:
                summary: Template message
                value:
                  message:
                    content: "Template message"
                    message_type: "template"
                    template_name: "hello_world"
                    template_language: "en_US"
                    template_params: ["John", "Smith"]
              template_message_named:
                summary: Template message with named parameters
                value:
                  message:
                    content: "Order notification"
                    message_type: "template"
                    template_name: "order_update"
                    template_language: "en_US"
                    template_params:
                      customer_name: "John Smith"
                      order_number: "ORD-2024-001"
                      status: "shipped"
                      tracking_number: "1Z999AA1234567890"
              template_message_named_with_header:
                summary: Template with named parameters in header and body
                value:
                  message:
                    content: "Promotional message"
                    message_type: "template"
                    template_name: "seasonal_sale_extended"
                    template_language: "en_US"
                    template_params:
                      header:
                        sale_name: "Summer Sale"
                      body:
                        end_date: "August 31st"
                        promo_code: "SUMMER25"
                        discount_amount: "25%"
              interactive_button:
                summary: Interactive button message
                value:
                  message:
                    content: "Choose an option"
                    message_type: "interactive"
                    interactive_type: "button"
                    body_text: "Please select one:"
                    buttons:
                      - id: "yes"
                        title: "Yes"
                      - id: "no"
                        title: "No"
              contacts_message:
                summary: Contact card message
                value:
                  message:
                    message_type: "contacts"
                    contacts:
                      - name:
                          formatted_name: "Barbara J. Johnson"
                          first_name: "Barbara"
                          last_name: "Johnson"
                          middle_name: "Joana"
                          prefix: "Dr."
                          suffix: "Esq."
                        birthday: "1999-01-23"
                        addresses:
                          - street: "1 Lucky Shrub Way"
                            city: "Menlo Park"
                            state: "CA"
                            zip: "94025"
                            country: "United States"
                            country_code: "US"
                            type: "Office"
                        emails:
                          - email: "bjohnson@luckyshrub.com"
                            type: "Work"
                        phones:
                          - phone: "+16505559999"
                            type: "Landline"
                          - phone: "+19175559999"
                            type: "Mobile"
                            wa_id: "19175559999"
                        org:
                          company: "Lucky Shrub"
                          department: "Legal"
                          title: "Lead Counsel"
                        urls:
                          - url: "https://www.luckyshrub.com"
                            type: "Company"
      responses:
        "201":
          description: Message created and sent successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/WhatsappMessage"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "409":
          description: Cannot send message when an agent execution is active
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: WhatsApp service error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /whatsapp_messages:
    post:
      summary: Send a WhatsApp message (standalone)
      description: |
        Sends a new WhatsApp message without requiring a conversation ID.
        This endpoint automatically finds or creates a conversation based on the phone number and WhatsApp configuration.

        **Configuration Selection:**
        - If `whatsapp_config_id` is provided, uses that specific configuration
        - If `customer_id` is provided, uses the customer's WhatsApp configuration
        - If neither is provided, uses the first available configuration for the project

        **Conversation Management:**
        - Automatically finds existing active conversations for the phone number
        - Creates new conversations if none exist
        - Updates conversation activity timestamps
        - Creates WhatsApp contacts as needed

        **Message Types:**
        Supports all message types including text, template, media, interactive, location, reaction, and contacts.

        **Agent Integration:**
        Respects agent execution states and handoff rules. Messages are blocked when an agent execution is active and not in handoff, failed, or stopped state.
      operationId: sendWhatsappMessage
      tags:
        - WhatsApp Messages
      parameters:
        - name: whatsapp_config_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: ID of the specific WhatsApp configuration to use
        - name: customer_id
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: ID of the customer whose WhatsApp configuration to use
        - name: phone_number
          in: query
          required: false
          schema:
            type: string
          description: Phone number to send the message to (can also be provided in the message object)
          example: "+1234567890"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - message
              properties:
                message:
                  type: object
                  required:
                    - phone_number
                  properties:
                    phone_number:
                      type: string
                      description: Phone number to send the message to (in international format)
                      example: "+1234567890"
                    content:
                      type: string
                      description: The message content to send (for text messages)
                      example: Hello, how can I help you today?
                    message_type:
                      type: string
                      description: The type of message
                      enum:
                        - text
                        - image
                        - video
                        - audio
                        - document
                        - template
                        - location
                        - interactive
                        - reaction
                        - contacts
                      default: text
                      example: text
                    media_url:
                      type: string
                      description: URL of the media file to send (for image, video, audio, document message types)
                    media_id:
                      type: string
                      description: WhatsApp media ID to use instead of a URL (for image, video, audio, document message types)
                    media_file:
                      type: string
                      format: binary
                      description: Media file upload (for image, video, audio, document message types)
                    caption:
                      type: string
                      description: Caption for media messages (image, video, document)
                    filename:
                      type: string
                      description: Filename for document messages
                    latitude:
                      type: number
                      format: float
                      description: Latitude for location messages
                    longitude:
                      type: number
                      format: float
                      description: Longitude for location messages
                    location_name:
                      type: string
                      description: Optional name for the location
                    location_address:
                      type: string
                      description: Optional address for the location
                    interactive_type:
                      type: string
                      enum:
                        - button
                        - list
                      description: Type of interactive message
                    body_text:
                      type: string
                      description: Main message text for interactive messages
                    header_text:
                      type: string
                      description: Header text for interactive messages
                    footer_text:
                      type: string
                      description: Footer text for interactive messages
                    buttons:
                      type: array
                      description: Button definitions for button-type interactive messages
                      items:
                        type: object
                        properties:
                          id:
                            type: string
                            description: Button identifier
                          title:
                            type: string
                            description: Button display text
                    sections:
                      type: array
                      description: Section definitions for list-type interactive messages
                      items:
                        type: object
                        properties:
                          title:
                            type: string
                            description: Section title
                          rows:
                            type: array
                            items:
                              type: object
                              properties:
                                id:
                                  type: string
                                  description: Row identifier
                                title:
                                  type: string
                                  description: Row title
                                description:
                                  type: string
                                  description: Optional row description
                    list_button_text:
                      type: string
                      description: Text for the button that opens the list (for list-type interactive messages)
                      example: View Options
                    template_name:
                      type: string
                      description: Name of the template to use
                    template_language:
                      type: string
                      description: Language code of the template (e.g., en_US)
                    template_params:
                      oneOf:
                        - type: array
                          description: Array of values for positional parameters (e.g., {{1}}, {{2}})
                          items:
                            type: string
                          example:
                            - John Smith
                            - Tomorrow at 2 PM
                        - type: object
                          description: Object with named parameters (e.g., {{name}}, {{email}})
                          additionalProperties:
                            type: string
                          example:
                            name: John Smith
                            email: john@example.com
                      description: |
                        Parameters to fill in the template placeholders.
                        Use array format for templates with positional parameters ({{1}}, {{2}}).
                        Use object format for templates with named parameters ({{name}}, {{email}}).
                    header_type:
                      type: string
                      description: Type of header for template messages
                      enum:
                        - text
                        - image
                        - video
                        - document
                    header_params:
                      type: string
                      description: Content for the template header (URL for media, text for text headers)
                    header_filename:
                      type: string
                      description: Filename for document headers
                    reaction_emoji:
                      type: string
                      description: Emoji to use for the reaction
                    reacted_to_message_id:
                      type: string
                      description: ID of the message to react to
                    contacts:
                      type: array
                      minItems: 1
                      maxItems: 257
                      description: |
                        Contact cards to send (required for contacts messages, 1-257 per WhatsApp guidelines).
                        At least one contact with a name is required.
                        Supports both nested name object and flattened name keys for backward compatibility.
                      items:
                        type: object
                        required:
                          - name
                        properties:
                          name:
                            type: object
                            description: Contact name (either formatted_name or first_name required)
                            properties:
                              formatted_name:
                                type: string
                                description: Full formatted contact name
                                example: "Barbara J. Johnson"
                              first_name:
                                type: string
                                description: First name
                                example: "Barbara"
                              last_name:
                                type: string
                                description: Last name
                                example: "Johnson"
                              middle_name:
                                type: string
                                description: Middle name
                                example: "Joana"
                              prefix:
                                type: string
                                description: Name prefix
                                example: "Dr."
                              suffix:
                                type: string
                                description: Name suffix
                                example: "Esq."
                          birthday:
                            type: string
                            format: date
                            description: Contact birthday (YYYY-MM-DD)
                            example: "1999-01-23"
                          addresses:
                            type: array
                            description: Physical addresses for the contact
                            items:
                              type: object
                              properties:
                                street:
                                  type: string
                                  description: Street address
                                  example: "1 Lucky Shrub Way"
                                city:
                                  type: string
                                  description: City
                                  example: "Menlo Park"
                                state:
                                  type: string
                                  description: State or province
                                  example: "CA"
                                zip:
                                  type: string
                                  description: ZIP or postal code
                                  example: "94025"
                                country:
                                  type: string
                                  description: Country name
                                  example: "United States"
                                country_code:
                                  type: string
                                  description: ISO country code
                                  example: "US"
                                type:
                                  type: string
                                  description: Address type
                                  example: "Office"
                          emails:
                            type: array
                            description: Email addresses for the contact
                            items:
                              type: object
                              required:
                                - email
                              properties:
                                email:
                                  type: string
                                  format: email
                                  description: Email address
                                  example: "bjohnson@luckyshrub.com"
                                type:
                                  type: string
                                  description: Email type
                                  example: "Work"
                          phones:
                            type: array
                            description: Phone numbers for the contact
                            items:
                              type: object
                              required:
                                - phone
                              properties:
                                phone:
                                  type: string
                                  description: Phone number (international format recommended)
                                  example: "+16505559999"
                                type:
                                  type: string
                                  description: Phone number type
                                  example: "Landline"
                                wa_id:
                                  type: string
                                  description: WhatsApp ID (normalized phone number without + prefix)
                                  example: "19175559999"
                          org:
                            type: object
                            description: Organization information
                            properties:
                              company:
                                type: string
                                description: Company name
                                example: "Lucky Shrub"
                              department:
                                type: string
                                description: Department name
                                example: "Legal"
                              title:
                                type: string
                                description: Job title
                                example: "Lead Counsel"
                          urls:
                            type: array
                            description: URLs for the contact
                            items:
                              type: object
                              required:
                                - url
                              properties:
                                url:
                                  type: string
                                  format: uri
                                  description: URL
                                  example: "https://www.luckyshrub.com"
                                type:
                                  type: string
                                  description: URL type
                                  example: "Company"
            examples:
              text_message:
                summary: Simple text message
                description: Send a basic text message
                value:
                  message:
                    phone_number: "+1234567890"
                    content: "Hello, how can I help you today?"
                    message_type: "text"
              template_message:
                summary: Template message with parameters
                description: Send a template message with parameters
                value:
                  message:
                    phone_number: "+1234567890"
                    message_type: "template"
                    template_name: "order_confirmation"
                    template_params: ["John Doe", "ORD-12345"]
              template_message_named:
                summary: Template message with named parameters
                description: Send a template message with named parameters (e.g., {{customer_name}}, {{order_id}})
                value:
                  message:
                    phone_number: "+1234567890"
                    message_type: "template"
                    template_name: "order_notification"
                    template_language: "en_US"
                    template_params:
                      customer_name: "John Doe"
                      order_id: "ORD-12345"
                      delivery_date: "Tomorrow at 2 PM"
                      total_amount: "$99.99"
              with_config:
                summary: Message with specific WhatsApp config
                description: Send a message using a specific WhatsApp configuration
                value:
                  whatsapp_config_id: "550e8400-e29b-41d4-a716-446655440000"
                  message:
                    phone_number: "+1234567890"
                    content: "Hello from specific config!"
                    message_type: "text"
              with_customer:
                summary: Message with customer specification
                description: Send a message using a customer's WhatsApp configuration
                value:
                  customer_id: "550e8400-e29b-41d4-a716-446655440001"
                  message:
                    phone_number: "+1234567890"
                    content: "Hello from customer's config!"
                    message_type: "text"
              contacts_message:
                summary: Contact card message
                description: Send a contact card with complete information
                value:
                  message:
                    phone_number: "+1234567890"
                    message_type: "contacts"
                    contacts:
                      - name:
                          formatted_name: "Barbara J. Johnson"
                          first_name: "Barbara"
                          last_name: "Johnson"
                          middle_name: "Joana"
                          prefix: "Dr."
                          suffix: "Esq."
                        birthday: "1999-01-23"
                        addresses:
                          - street: "1 Lucky Shrub Way"
                            city: "Menlo Park"
                            state: "CA"
                            zip: "94025"
                            country: "United States"
                            country_code: "US"
                            type: "Office"
                        emails:
                          - email: "bjohnson@luckyshrub.com"
                            type: "Work"
                        phones:
                          - phone: "+16505559999"
                            type: "Landline"
                          - phone: "+19175559999"
                            type: "Mobile"
                            wa_id: "19175559999"
                        org:
                          company: "Lucky Shrub"
                          department: "Legal"
                          title: "Lead Counsel"
                        urls:
                          - url: "https://www.luckyshrub.com"
                            type: "Company"
      responses:
        "201":
          description: Message created and sent successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/WhatsappMessage"
              examples:
                text_message:
                  summary: Text message response
                  value:
                    data:
                      id: "msg-123abc"
                      phone_number: "+1234567890"
                      message_type: "text"
                      content: "Hello, how can I help you today?"
                      direction: "outbound"
                      status: "sent"
                      whatsapp_message_id: "wamid.HBgLMTIzNDU2Nzg5MAUCAw=="
                      created_at: "2024-01-15T10:30:00Z"
                      updated_at: "2024-01-15T10:30:00Z"
                template_message:
                  summary: Template message response
                  value:
                    data:
                      id: "msg-456def"
                      phone_number: "+1234567890"
                      message_type: "template"
                      content: "Hi John Doe, your order ORD-12345 has been confirmed!"
                      direction: "outbound"
                      status: "sent"
                      whatsapp_message_id: "wamid.HBgLMTIzNDU2Nzg5MAUCAw=="
                      metadata:
                        template_name: "order_confirmation"
                        template_params: ["John Doe", "ORD-12345"]
                      created_at: "2024-01-15T10:30:00Z"
                      updated_at: "2024-01-15T10:30:00Z"
                template_message_named:
                  summary: Template message with named params response
                  value:
                    data:
                      id: "msg-789ghi"
                      phone_number: "+1234567890"
                      message_type: "template"
                      content: "Hi John Doe, your order ORD-12345 totaling $99.99 will be delivered Tomorrow at 2 PM!"
                      direction: "outbound"
                      status: "sent"
                      whatsapp_message_id: "wamid.HBgLMTIzNDU2Nzg5MAUCAw=="
                      metadata:
                        template_name: "order_notification"
                        template_language: "en_US"
                        template_params:
                          customer_name: "John Doe"
                          order_id: "ORD-12345"
                          delivery_date: "Tomorrow at 2 PM"
                          total_amount: "$99.99"
                      created_at: "2024-01-15T10:30:00Z"
                      updated_at: "2024-01-15T10:30:00Z"
                template_with_header_body_named:
                  summary: Template with named params in header and body response
                  value:
                    data:
                      id: "msg-101jkl"
                      phone_number: "+1234567890"
                      message_type: "template"
                      content: "Summer Sale: Shop now through August 31st and use code SUMMER25 to get 25% off!"
                      direction: "outbound"
                      status: "sent"
                      whatsapp_message_id: "wamid.HBgLMTIzNDU2Nzg5MAUCAw=="
                      metadata:
                        template_name: "seasonal_sale_extended"
                        template_language: "en_US"
                        template_params:
                          header:
                            sale_name: "Summer Sale"
                          body:
                            end_date: "August 31st"
                            promo_code: "SUMMER25"
                            discount_amount: "25%"
                      created_at: "2024-01-15T10:30:00Z"
                      updated_at: "2024-01-15T10:30:00Z"
                contacts_message:
                  summary: Contact card message response
                  value:
                    data:
                      id: "msg-202mno"
                      phone_number: "+1234567890"
                      message_type: "contacts"
                      content: "Contact: Barbara J. Johnson"
                      direction: "outbound"
                      status: "sent"
                      whatsapp_message_id: "wamid.HBgLMTIzNDU2Nzg5MAUCAw=="
                      metadata:
                        contacts_data:
                          - name:
                              formatted_name: "Barbara J. Johnson"
                              first_name: "Barbara"
                              last_name: "Johnson"
                              middle_name: "Joana"
                              prefix: "Dr."
                              suffix: "Esq."
                            birthday: "1999-01-23"
                            addresses:
                              - street: "1 Lucky Shrub Way"
                                city: "Menlo Park"
                                state: "CA"
                                zip: "94025"
                                country: "United States"
                                country_code: "US"
                                type: "Office"
                            emails:
                              - email: "bjohnson@luckyshrub.com"
                                type: "Work"
                            phones:
                              - phone: "+16505559999"
                                type: "Landline"
                              - phone: "+19175559999"
                                type: "Mobile"
                                wa_id: "19175559999"
                            org:
                              company: "Lucky Shrub"
                              department: "Legal"
                              title: "Lead Counsel"
                            urls:
                              - url: "https://www.luckyshrub.com"
                                type: "Company"
                      created_at: "2024-01-15T10:30:00Z"
                      updated_at: "2024-01-15T10:30:00Z"
        "400":
          description: Bad request - missing required parameters
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                missing_phone:
                  summary: Missing phone number
                  value:
                    error: "Phone number is required"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Template not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                template_not_found:
                  summary: Template not found
                  value:
                    error: "Template not found"
        "409":
          description: Cannot send message when an agent execution is active
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                agent_active:
                  summary: Agent execution conflict
                  value:
                    error: "Cannot send a manual message when an agent execution is active and not in handoff, failed, or stopped state"
        "422":
          description: Validation error or WhatsApp configuration not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                config_not_found:
                  summary: WhatsApp configuration not found
                  value:
                    error: "WhatsApp configuration not found"
        "500":
          description: WhatsApp service error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /whatsapp_messages/{id}/mark_as_read:
    patch:
      summary: Mark WhatsApp message as read
      description: |
        Marks an inbound WhatsApp message as read and syncs the status with WhatsApp API.

        **Key Features:**
        - Only inbound messages can be marked as read
        - Optimistically updates local status for immediate feedback
        - Asynchronously syncs with WhatsApp API via background job
        - Skips messages already marked as read
        - Supports optional typing indicator control

        **Sandbox Mode:**
        Messages from sandbox conversations (no WhatsApp config) are handled appropriately with sandbox-specific processing.
      operationId: markWhatsappMessageAsRead
      tags:
        - WhatsApp Messages
      parameters:
        - name: id
          in: path
          required: true
          description: The ID of the WhatsApp message to mark as read
          schema:
            type: string
            format: uuid
        - name: typing_indicator
          in: query
          required: false
          description: Whether to show typing indicator in WhatsApp (defaults to true)
          schema:
            type: boolean
            default: true
      responses:
        "200":
          description: Message successfully marked as read
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/WhatsappMessage"
              examples:
                success:
                  summary: Message marked as read
                  value:
                    data:
                      id: "msg-123abc"
                      phone_number: "+1234567890"
                      message_type: "text"
                      content: "Hello"
                      direction: "inbound"
                      status: "read"
                      whatsapp_message_id: "wamid.HBgLMTIzNDU2Nzg5MAUCAw=="
                      created_at: "2024-01-15T10:30:00Z"
                      updated_at: "2024-01-15T10:31:00Z"
        "400":
          description: Bad request - attempting to mark outbound message as read
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                outbound_message:
                  summary: Cannot mark outbound message
                  value:
                    error: "Can only mark inbound messages as read"
        "401":
          description: Unauthorized - invalid or missing API key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Message not found or doesn't belong to authorized project
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                not_found:
                  summary: Message not found
                  value:
                    error: "WhatsApp message not found"
  /whatsapp_messages/{id}:
    delete:
      summary: Delete WhatsApp message
      description: |
        Deletes a WhatsApp message from the system.

        **Note:**
        This operation only deletes the message from the system, not from WhatsApp itself.
      operationId: deleteWhatsappMessage
      tags:
        - WhatsApp Messages
      parameters:
        - name: id
          in: path
          required: true
          description: The ID of the WhatsApp message to delete
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Message successfully deleted
        "401":
          description: Unauthorized - invalid or missing API key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - not authorized to delete this message
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Message not found or doesn't belong to authorized project
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                not_found:
                  summary: Message not found
                  value:
                    error: "WhatsApp message not found"
  /whatsapp_conversations/{conversation_id}/agent_executions:
    get:
      summary: List agent executions for a WhatsApp conversation
      description:
        Returns all agent executions associated with a specific WhatsApp
        conversation
      operationId: listWhatsappConversationAgentExecutions
      tags:
        - WhatsApp Conversations
      parameters:
        - name: conversation_id
          in: path
          required: true
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        "200":
          description: A list of agent execution associations
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/WhatsappConversationAgentExecution"
                  meta:
                    type: object
                    properties:
                      page:
                        type: integer
                      per_page:
                        type: integer
                      total_pages:
                        type: integer
                      total_count:
                        type: integer
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /whatsapp_conversations/{conversation_id}/agent_executions/{id}:
    get:
      summary: Get agent execution association details
      description: Returns details for a specific agent execution association
      operationId: getWhatsappConversationAgentExecution
      tags:
        - WhatsApp Conversations
      parameters:
        - name: conversation_id
          in: path
          required: true
          schema:
            type: string
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Agent execution association details
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/WhatsappConversationAgentExecution"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Conversation or association not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /whatsapp_conversations/{whatsapp_conversation_id}/conversation_assignments:
    get:
      summary: List conversation assignments
      description: Returns a list of assignments for a specific WhatsApp conversation
      operationId: listConversationAssignments
      tags:
        - Conversation Assignments
      parameters:
        - name: whatsapp_conversation_id
          in: path
          required: true
          description: ID of the WhatsApp conversation
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        "200":
          description: A list of conversation assignments
          headers:
            Total:
              schema:
                type: integer
              description: Total number of records
            Total-Pages:
              schema:
                type: integer
              description: Total number of pages
            Per-Page:
              schema:
                type: integer
              description: Number of items per page
            Page:
              schema:
                type: integer
              description: Current page number
            Link:
              schema:
                type: string
              description: Links to first, prev, next, and last pages
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/ConversationAssignment"
                  meta:
                    type: object
                    properties:
                      page:
                        type: integer
                      per_page:
                        type: integer
                      total_pages:
                        type: integer
                      total_count:
                        type: integer
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      summary: Create a conversation assignment
      description: Creates a new assignment for a WhatsApp conversation
      operationId: createConversationAssignment
      tags:
        - Conversation Assignments
      parameters:
        - name: whatsapp_conversation_id
          in: path
          required: true
          description: ID of the WhatsApp conversation
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - conversation_assignment
              properties:
                conversation_assignment:
                  type: object
                  required:
                    - user_id
                  properties:
                    user_id:
                      type: string
                      format: uuid
                      description: ID of the user to assign the conversation to
                    notes:
                      type: string
                      description: Optional notes for the assignment
      responses:
        "201":
          description: Assignment created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/ConversationAssignment"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Conversation or User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "422":
          description:
            Validation error (e.g., user not in project, conversation already
            assigned)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /whatsapp_conversations/{whatsapp_conversation_id}/conversation_assignments/{id}:
    patch:
      summary: Update a conversation assignment
      description:
        Updates an existing conversation assignment (e.g., notes, user,
        active status)
      operationId: updateConversationAssignment
      tags:
        - Conversation Assignments
      parameters:
        - name: whatsapp_conversation_id
          in: path
          required: true
          description: ID of the WhatsApp conversation
          schema:
            type: string
        - name: id
          in: path
          required: true
          description: ID of the conversation assignment
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - conversation_assignment
              properties:
                conversation_assignment:
                  type: object
                  properties:
                    user_id:
                      type: string
                      format: uuid
                      description: ID of the new user to assign the conversation to
                    notes:
                      type: string
                      description: Updated notes for the assignment
                    active:
                      type: boolean
                      description: Set to false to deactivate the assignment
      responses:
        "200":
          description: Assignment updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/ConversationAssignment"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Conversation, Assignment, or User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "422":
          description: Validation error (e.g., user not in project)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /whatsapp_templates:
    get:
      summary: List WhatsApp templates
      description: Returns a list of WhatsApp templates available for the project
      operationId: listWhatsappTemplates
      tags:
        - WhatsApp Templates
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: customer_id
          in: query
          description: Filter templates by customer ID
          schema:
            type: string
            format: uuid
        - name: q[name_cont]
          in: query
          description: Filter templates by name (contains)
          schema:
            type: string
        - name: q[language_code_eq]
          in: query
          description: Filter templates by exact language code match
          schema:
            type: string
        - name: q[category_eq]
          in: query
          description: Filter templates by category
          schema:
            type: string
            enum:
              - MARKETING
              - UTILITY
              - AUTHENTICATION
        - name: q[status_eq]
          in: query
          description: Filter templates by status
          schema:
            type: string
            enum:
              - draft
              - submitted
              - approved
              - rejected
              - disabled
        - name: q[customer_id_eq]
          in: query
          description: Filter templates by customer ID (Ransack syntax)
          schema:
            type: string
            format: uuid
        - name: business_account_id
          in: query
          description: Filter templates by WhatsApp Business Account ID
          schema:
            type: string
          example: "123456789012345"
        - name: q[business_account_id_eq]
          in: query
          description: Filter templates by WhatsApp Business Account ID (Ransack syntax)
          schema:
            type: string
          example: "123456789012345"
        - name: whatsapp_config_id
          in: query
          description: Filter templates by WhatsApp configuration ID
          schema:
            type: string
            format: uuid
        - name: q[whatsapp_config_id_eq]
          in: query
          description: Filter templates by WhatsApp configuration ID (Ransack syntax)
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: A list of WhatsApp templates
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/WhatsappTemplate"
                  meta:
                    type: object
                    properties:
                      page:
                        type: integer
                      per_page:
                        type: integer
                      total_pages:
                        type: integer
                      total_count:
                        type: integer
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      summary: Create a new WhatsApp template
      description: |
        Creates a new draft template that can be later submitted to WhatsApp for approval.

        When a whatsapp_config_id (or customer_id) is provided, the template is automatically
        associated with all production configs that share the same WhatsApp Business Account (WABA).

        Note: You cannot associate templates with configs from different WABAs. Attempting to do so
        will return a 422 validation error.
      operationId: createWhatsappTemplate
      tags:
        - WhatsApp Templates
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - template
              properties:
                template:
                  type: object
                  required:
                    - name
                    - language_code
                    - category
                    - components
                  properties:
                    name:
                      type: string
                      description: Template name (must be unique per language)
                      example: appointment_reminder
                    language_code:
                      type: string
                      description: Language code (e.g., 'en_US')
                      example: en_US
                    category:
                      type: string
                      description: Template category
                      enum:
                        - MARKETING
                        - UTILITY
                        - AUTHENTICATION
                      example: UTILITY
                    parameter_format:
                      type: string
                      description: Parameter format - NAMED for named parameters like {{customer_name}}, POSITIONAL for {{1}}, {{2}}
                      enum:
                        - NAMED
                        - POSITIONAL
                      default: POSITIONAL
                      example: NAMED
                    components:
                      type: array
                      description: Template components structure (array of component objects)
                      items:
                        type: object
                        properties:
                          type:
                            type: string
                            enum: [HEADER, BODY, FOOTER, BUTTONS]
                            description: Component type
                          format:
                            type: string
                            enum: [TEXT, IMAGE, VIDEO, DOCUMENT, LOCATION]
                            description: Format for HEADER components
                          text:
                            type: string
                            description: Text content of the component
                          example:
                            type: object
                            description: Example media for HEADER components
                            properties:
                              header_handle:
                                type: array
                                items:
                                  type: string
                          buttons:
                            type: array
                            description: Array of buttons for BUTTONS component
                            items:
                              type: object
                              properties:
                                type:
                                  type: string
                                  enum: [QUICK_REPLY, URL, PHONE_NUMBER]
                                text:
                                  type: string
                                url:
                                  type: string
                                  description: URL for URL type buttons
                                phone_number:
                                  type: string
                                  description: Phone number for PHONE_NUMBER type buttons
                whatsapp_config_id:
                  type: string
                  format: uuid
                  description: |
                    Optional: Specific WhatsApp phone number configuration to associate with template.
                    Templates can be associated with multiple phone numbers (WhatsApp configs).
                    Association options:
                    - If whatsapp_config_id provided: associates with that specific phone number only
                    - If customer_id provided: associates with ALL production configs of that customer
                    - If neither provided: associates with ALL production configs of the project
                customer_id:
                  type: string
                  format: uuid
                  description: |
                    Optional: Customer whose WhatsApp configs to associate with template.
                    When provided, the template will be associated with ALL production WhatsApp configs
                    (phone numbers) belonging to this customer, making it available for sending from any of them.
            examples:
              simple_text_template:
                summary: Simple text-only template
                description: Basic template with only a BODY component containing plain text
                value:
                  template:
                    name: welcome_message
                    language_code: en_US
                    category: UTILITY
                    components:
                      - type: BODY
                        text: "Welcome to our service! We're excited to have you on board."
              template_with_positional_params:
                summary: Template with positional parameters
                description: Template using numbered placeholders ({{1}}, {{2}}) - legacy format
                value:
                  template:
                    name: appointment_reminder_legacy
                    language_code: en_US
                    category: UTILITY
                    parameter_format: POSITIONAL
                    components:
                      - type: BODY
                        text: "Hello {{1}}, your appointment is scheduled for {{2}} at {{3}}. Please arrive 15 minutes early."
                        example:
                          body_text:
                            - ["John Smith", "December 15th", "2:30 PM"]
              template_with_named_parameters:
                summary: Template with named parameters
                description: Template using named placeholders like {{customer_name}}, {{date}} for dynamic content
                value:
                  template:
                    name: appointment_reminder
                    language_code: en_US
                    category: UTILITY
                    parameter_format: NAMED
                    components:
                      - type: BODY
                        text: "Hello {{customer_name}}, your appointment is scheduled for {{appointment_date}} at {{appointment_time}}. Please arrive 15 minutes early."
                        example:
                          body_text_named_params:
                            - param_name: customer_name
                              example: John Smith
                            - param_name: appointment_date
                              example: December 15th
                            - param_name: appointment_time
                              example: 2:30 PM
              template_with_header_footer:
                summary: Template with header, body, and footer (named parameters)
                description: Complete template structure with all text components using named parameters
                value:
                  template:
                    name: order_confirmation
                    language_code: en_US
                    category: UTILITY
                    parameter_format: NAMED
                    components:
                      - type: HEADER
                        format: TEXT
                        text: "Order Confirmation #{{order_id}}"
                        example:
                          header_text_named_params:
                            - param_name: order_id
                              example: ORD-2024-001
                      - type: BODY
                        text: "Thank you {{customer_name}}! Your order #{{order_number}} has been confirmed and will be delivered by {{delivery_date}}."
                        example:
                          body_text_named_params:
                            - param_name: customer_name
                              example: Jane Doe
                            - param_name: order_number
                              example: ORD-2024-001
                            - param_name: delivery_date
                              example: December 20th
                      - type: FOOTER
                        text: "Questions? Contact support@example.com"
              template_with_image_header:
                summary: Template with image header (named parameters)
                description: Marketing template with an image header and body text using named parameters
                value:
                  template:
                    name: seasonal_sale
                    language_code: en_US
                    category: MARKETING
                    parameter_format: NAMED
                    components:
                      - type: HEADER
                        format: IMAGE
                        example:
                          header_handle:
                            - "4::aW..."
                      - type: BODY
                        text: " {{season_name}} Sale is here! Get {{discount_percentage}} off on all items. Use code: {{promo_code}}"
                        example:
                          body_text_named_params:
                            - param_name: season_name
                              example: Summer
                            - param_name: discount_percentage
                              example: 30%
                            - param_name: promo_code
                              example: SUMMER30
                      - type: FOOTER
                        text: "Valid until August 31st"
              template_with_buttons:
                summary: Template with quick reply buttons (named parameters)
                description: Interactive template with body text and quick reply buttons using named parameters
                value:
                  template:
                    name: feedback_request
                    language_code: en_US
                    category: UTILITY
                    parameter_format: NAMED
                    components:
                      - type: BODY
                        text: "Hi {{customer_name}}, how was your experience with our service today?"
                        example:
                          body_text_named_params:
                            - param_name: customer_name
                              example: John
                      - type: BUTTONS
                        buttons:
                          - type: QUICK_REPLY
                            text: "Excellent"
                          - type: QUICK_REPLY
                            text: "Good"
                          - type: QUICK_REPLY
                            text: "Needs Improvement"
              template_with_url_button:
                summary: Template with URL button (named parameters)
                description: Template with a call-to-action URL button using named parameters
                value:
                  template:
                    name: track_order
                    language_code: en_US
                    category: UTILITY
                    parameter_format: NAMED
                    components:
                      - type: BODY
                        text: "Your order #{{order_id}} is on its way! Track your delivery in real-time."
                        example:
                          body_text_named_params:
                            - param_name: order_id
                              example: ORD-2024-123
                      - type: BUTTONS
                        buttons:
                          - type: URL
                            text: "Track Order"
                            url: "https://example.com/track/{{order_id}}"
                            example: ["ORD-2024-123"]
              template_with_phone_button:
                summary: Template with phone number button
                description: Customer support template with a phone number button
                value:
                  template:
                    name: support_contact
                    language_code: en_US
                    category: UTILITY
                    components:
                      - type: BODY
                        text: "Hi {{1}}, we noticed you might need help with your recent purchase. Our support team is ready to assist you."
                        example:
                          body_text:
                            - ["John"]
                      - type: BUTTONS
                        buttons:
                          - type: PHONE_NUMBER
                            text: "Call Support"
                            phone_number: "+1234567890"
              marketing_template_complete:
                summary: Complete marketing template
                description: Full-featured marketing template with video header, body, footer, and multiple buttons
                value:
                  template:
                    name: product_launch
                    language_code: en_US
                    category: MARKETING
                    components:
                      - type: HEADER
                        format: VIDEO
                        example:
                          header_handle:
                            - "4::aW..."
                      - type: BODY
                        text: " Introducing {{1}}! Be among the first to experience {{2}}. Limited time offer: {{3}} off for early adopters!"
                        example:
                          body_text:
                            - ["Product X", "innovation", "25%"]
                      - type: FOOTER
                        text: "Offer valid until December 31st"
                      - type: BUTTONS
                        buttons:
                          - type: QUICK_REPLY
                            text: "Get Offer"
                          - type: URL
                            text: "Learn More"
                            url: "https://example.com/products/{{1}}"
                            example: ["product-x"]
              authentication_template:
                summary: Authentication template with OTP (positional)
                description: Two-factor authentication template using positional parameters
                value:
                  template:
                    name: otp_verification
                    language_code: en_US
                    category: AUTHENTICATION
                    parameter_format: POSITIONAL
                    components:
                      - type: BODY
                        text: "Your verification code is {{1}}. This code will expire in {{2}} minutes. Do not share this code with anyone."
                        example:
                          body_text:
                            - ["123456", "10"]
                      - type: FOOTER
                        text: "Didn't request this? Contact security@example.com"
              authentication_template_named:
                summary: Authentication template with OTP (named parameters)
                description: Two-factor authentication template using named parameters
                value:
                  template:
                    name: otp_verification_named
                    language_code: en_US
                    category: AUTHENTICATION
                    parameter_format: NAMED
                    components:
                      - type: BODY
                        text: "Your verification code is {{otp_code}}. This code will expire in {{expiry_minutes}} minutes. Do not share this code with anyone."
                        example:
                          body_text_named_params:
                            - param_name: otp_code
                              example: "123456"
                            - param_name: expiry_minutes
                              example: "10"
                      - type: FOOTER
                        text: "Didn't request this? Contact security@example.com"
              spanish_template:
                summary: Spanish language template
                description: Template in Spanish for international customers
                value:
                  template:
                    name: bienvenida
                    language_code: es_ES
                    category: UTILITY
                    components:
                      - type: HEADER
                        format: TEXT
                        text: "Bienvenido!"
                      - type: BODY
                        text: "Hola {{1}}, gracias por unirte a nuestro servicio. Tu cuenta ha sido creada exitosamente."
                        example:
                          body_text:
                            - ["Mara"]
                      - type: FOOTER
                        text: "Necesitas ayuda? Contctanos"
      responses:
        "201":
          description: Template created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/WhatsappTemplate"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Invalid template
                  errors:
                    type: array
                    items:
                      type: string
                    example:
                      - Name can't be blank
                      - Language code is not valid
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: error
                  message:
                    type: string
                    example: "Failed to create template: Internal Error"
  /whatsapp_templates/{template_id}:
    get:
      summary: Get WhatsApp template details
      description: Returns details for a specific WhatsApp template
      operationId: getWhatsappTemplate
      tags:
        - WhatsApp Templates
      parameters:
        - name: template_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: WhatsApp template details
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/WhatsappTemplate"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Template not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      summary: Delete a WhatsApp template
      description: |
        Deletes a WhatsApp template from both the local database and WhatsApp's servers.

        **Behavior:**
        - If template is already marked as removed, returns the template without making API calls
        - Otherwise, deletes the template from WhatsApp API first, then marks it as removed locally
        - Requires a production WhatsApp configuration associated with the template's Business Account

        **Note:** This operation marks the template as removed rather than completely deleting it from the database.
      operationId: deleteWhatsappTemplate
      tags:
        - WhatsApp Templates
      parameters:
        - name: template_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Template deleted successfully (returns updated template with removed status)
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/WhatsappTemplate"
              examples:
                deleted_template:
                  summary: Successfully deleted template
                  value:
                    data:
                      id: "template-123abc"
                      name: "old_promotion"
                      language_code: "en_US"
                      category: "MARKETING"
                      status: "removed"
                      business_account_id: "123456789012345"
                      created_at: "2024-01-10T10:00:00Z"
                      updated_at: "2024-01-15T14:30:00Z"
        "401":
          description: Unauthorized - invalid or missing API key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Template not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                not_found:
                  summary: Template not found
                  value:
                    error: "Template not found"
        "422":
          description: Unable to delete template
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Failed to delete template from WhatsApp"
                  message:
                    type: string
                    example: "Template is currently in use"
                  meta:
                    type: object
                    description: Additional error details from WhatsApp API
              examples:
                no_config:
                  summary: No production config found
                  value:
                    error: "Production WhatsApp configuration not found for template"
                whatsapp_api_error:
                  summary: WhatsApp API error
                  value:
                    error: "Failed to delete template from WhatsApp"
                    message: "Template is currently in use and cannot be deleted"
                    meta:
                      error_code: 100
                      error_subcode: 2388090
    patch:
      summary: Update a WhatsApp template
      description: Updates an existing draft template. Only draft templates can be updated.
      operationId: updateWhatsappTemplate
      tags:
        - WhatsApp Templates
      parameters:
        - name: template_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - template
              properties:
                template:
                  type: object
                  properties:
                    name:
                      type: string
                      description: Template name (must be unique per language)
                      example: appointment_reminder_updated
                    language_code:
                      type: string
                      description: Language code (e.g., 'en_US')
                      example: en_US
                    category:
                      type: string
                      description: Template category
                      enum:
                        - MARKETING
                        - UTILITY
                        - AUTHENTICATION
                      example: UTILITY
                    parameter_format:
                      type: string
                      description: Parameter format - NAMED for named parameters like {{customer_name}}, POSITIONAL for {{1}}, {{2}}
                      enum:
                        - NAMED
                        - POSITIONAL
                      default: POSITIONAL
                      example: NAMED
                    components:
                      type: array
                      description: Template components structure (array of component objects)
                      items:
                        type: object
                        properties:
                          type:
                            type: string
                            enum: [HEADER, BODY, FOOTER, BUTTONS]
                            description: Component type
                          format:
                            type: string
                            enum: [TEXT, IMAGE, VIDEO, DOCUMENT, LOCATION]
                            description: Format for HEADER components
                          text:
                            type: string
                            description: Text content of the component
                          example:
                            type: object
                            description: Example media for HEADER components
                            properties:
                              header_handle:
                                type: array
                                items:
                                  type: string
                          buttons:
                            type: array
                            description: Array of buttons for BUTTONS component
                            items:
                              type: object
                              properties:
                                type:
                                  type: string
                                  enum: [QUICK_REPLY, URL, PHONE_NUMBER]
                                text:
                                  type: string
                                url:
                                  type: string
                                  description: URL for URL type buttons
                                phone_number:
                                  type: string
                                  description: Phone number for PHONE_NUMBER type buttons
            examples:
              update_body_text:
                summary: Update body text with named parameters
                description: Updates the body component to use named parameters
                value:
                  template:
                    parameter_format: NAMED
                    components:
                      - type: BODY
                        text: "Hello {{customer_name}}, your appointment has been rescheduled to {{new_date}} at {{new_time}}. Please confirm your attendance."
                        example:
                          body_text_named_params:
                            - param_name: customer_name
                              example: John
                            - param_name: new_date
                              example: December 20th
                            - param_name: new_time
                              example: 3:00 PM
              add_footer:
                summary: Add a footer to existing template
                description: Adds a footer component to a template that didn't have one
                value:
                  template:
                    components:
                      - type: BODY
                        text: "Your order #{{1}} is ready for pickup!"
                        example:
                          body_text:
                            - ["ORD-2024-456"]
                      - type: FOOTER
                        text: "Store hours: Mon-Fri 9AM-6PM"
              change_to_marketing:
                summary: Change category and add buttons with named parameters
                description: Updates template category to MARKETING with named parameters and adds quick reply buttons
                value:
                  template:
                    category: MARKETING
                    parameter_format: NAMED
                    components:
                      - type: HEADER
                        format: IMAGE
                        example:
                          header_handle:
                            - "4::aW..."
                      - type: BODY
                        text: " Special offer just for you, {{customer_name}}! Get {{discount}} off your next purchase."
                        example:
                          body_text_named_params:
                            - param_name: customer_name
                              example: Sarah
                            - param_name: discount
                              example: 20%
                      - type: BUTTONS
                        buttons:
                          - type: QUICK_REPLY
                            text: "Shop Now"
                          - type: QUICK_REPLY
                            text: "View Details"
              update_complete_template:
                summary: Complete template update
                description: Updates all aspects of a template including name, category, and components
                value:
                  template:
                    name: summer_sale_2024
                    category: MARKETING
                    components:
                      - type: HEADER
                        format: VIDEO
                        example:
                          header_handle:
                            - "4::aW..."
                      - type: BODY
                        text: " Summer Sale Extended! Hi {{1}}, enjoy {{2}} off everything until {{3}}. Use code: SUMMER24"
                        example:
                          body_text:
                            - ["Customer", "40%", "August 31st"]
                      - type: FOOTER
                        text: "Terms and conditions apply"
                      - type: BUTTONS
                        buttons:
                          - type: URL
                            text: "Shop Collection"
                            url: "https://example.com/summer-sale"
                          - type: PHONE_NUMBER
                            text: "Call Us"
                            phone_number: "+1234567890"
      responses:
        "200":
          description: Template updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/WhatsappTemplate"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Template not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "422":
          description: Validation error (e.g., template not in draft status)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Only draft templates can be updated
                  errors:
                    type: array
                    items:
                      type: string
                    example:
                      - Name can't be blank
                      - Language code is not valid
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: error
                  message:
                    type: string
                    example: "Failed to update template: Internal Error"
  /whatsapp_templates/{template_id}/send_template:
    post:
      summary: Send a WhatsApp template message
      description: Sends a WhatsApp template message to a specified phone number
      operationId: sendWhatsappTemplate
      tags:
        - WhatsApp Templates
      parameters:
        - name: template_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - template
              properties:
                template:
                  type: object
                  required:
                    - phone_number
                  properties:
                    phone_number:
                      type: string
                      description: Phone number to send the template message to
                      example: "+123456789012"
                    template_parameters:
                      oneOf:
                        - type: array
                          description:
                            Array of values for positional parameters (e.g.,
                            {{1}}, {{2}})
                          items:
                            type: string
                          example:
                            - John Smith
                            - Tomorrow at 2 PM
                        - type: object
                          description:
                            Object with named parameters (e.g., {{name}},
                            {{email}})
                          additionalProperties:
                            type: string
                          example:
                            name: John Smith
                            email: john@example.com
                      description:
                        "Parameters to fill in the template placeholders.\
                        \ \nUse array format for templates with positional parameters\
                        \ ({{1}}, {{2}}).\nUse object format for templates with named\
                        \ parameters ({{name}}, {{email}}).\nThe system automatically\
                        \ detects which format to use based on the template configuration.\n"
                    header_type:
                      type: string
                      description: Type of header for the template
                      enum:
                        - text
                        - image
                        - video
                        - document
                      example: image
                    header_params:
                      type: string
                      description:
                        Content for the template header (URL for media,
                        text for text headers)
                      example: https://example.com/header-image.jpg
                    header_filename:
                      type: string
                      description:
                        Filename for document headers (only used when header_type
                        is document)
                      example: invoice.pdf
                    whatsapp_config_id:
                      type: string
                      format: uuid
                      description: |
                        Optional: Specific WhatsApp phone number configuration to use for sending.
                        Templates can be associated with multiple phone numbers (WhatsApp configs).
                        Priority for phone number selection:
                        1. If whatsapp_config_id provided: uses that specific phone number
                        2. If customer_id provided: uses first customer config with template access
                        3. If neither provided: uses first available project config with template access
                    customer_id:
                      type: string
                      format: uuid
                      description: |
                        Optional: Customer ID whose WhatsApp configs to search.
                        The system will use the first production config of this customer that has access to the template.
                        Use this when you want to send from a customer's phone number without specifying which one.
                    button_url_params:
                      type: object
                      description: Parameters for URL buttons with dynamic content ({{1}} placeholders)
                      additionalProperties:
                        type: string
                      example:
                        "0": "track123"
                      nullable: true
            examples:
              basic_template:
                summary: Basic template without URL button
                value:
                  template:
                    phone_number: "+123456789012"
                    template_parameters:
                      - "John Smith"
                      - "Tomorrow at 2 PM"
              template_with_button_url:
                summary: Template with URL button parameter
                description: Use button_url_params when template has URL buttons with {{1}} placeholders
                value:
                  template:
                    phone_number: "+123456789012"
                    template_parameters: []
                    button_url_params:
                      "0": "track123"
              template_with_header_and_button:
                summary: Template with image header and URL button
                value:
                  template:
                    phone_number: "+123456789012"
                    template_parameters:
                      - "John Smith"
                    header_type: "image"
                    header_params: "https://example.com/order-image.jpg"
                    button_url_params:
                      "0": "order456"
              template_with_named_parameters:
                summary: Template with named parameters
                description: Use object format for templates with named parameters like {{email}}, {{name}}
                value:
                  template:
                    phone_number: "+123456789012"
                    template_parameters:
                      email: "john@example.com"
                      name: "John Smith"
              template_named_with_header:
                summary: Named parameters template with text header
                description: Template with named parameters in both header and body
                value:
                  template:
                    phone_number: "+123456789012"
                    template_parameters:
                      name: "John Smith"
                    header_type: "text"
                    header_params: "Welcome Message"
      responses:
        "200":
          description: Template message sent successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  message:
                    type: string
                    example: Template message sent successfully
                  template_id:
                    type: string
                    format: uuid
                  template_name:
                    type: string
                  response:
                    type: object
                    description: WhatsApp API response
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Template not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Template requires 2 parameters, but 1 were provided
        "500":
          description: WhatsApp service error
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: error
                  message:
                    type: string
                    example: "Failed to send template message: API Error"
  /whatsapp_templates/{template_id}/submit:
    post:
      summary: Submit a WhatsApp template for approval
      description: Submits a draft template to WhatsApp for approval. Only draft templates can be submitted.
      operationId: submitWhatsappTemplate
      tags:
        - WhatsApp Templates
      parameters:
        - name: template_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                whatsapp_config_id:
                  type: string
                  format: uuid
                  description: Optional specific WhatsApp configuration to use for submission
                customer_id:
                  type: string
                  format: uuid
                  description: Optional customer ID whose WhatsApp config to use for submission
      responses:
        "200":
          description: Template submitted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  message:
                    type: string
                    example: Template submitted successfully
                  template_id:
                    type: string
                    format: uuid
                  template_name:
                    type: string
                  submission_id:
                    type: string
                    description: WhatsApp submission ID
                  data:
                    $ref: "#/components/schemas/WhatsappTemplate"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Template not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "422":
          description: Validation error (e.g., template not in draft status)
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: error
                  message:
                    type: string
                    example: Failed to submit template
                  error:
                    type: string
                    example: Only draft templates can be submitted
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: error
                  message:
                    type: string
                    example: "Failed to submit template: Internal Error"
  /whatsapp_templates/{template_id}/meta:
    patch:
      summary: Edit a WhatsApp template on Meta
      description: |
        Edits a WhatsApp template via Meta's Graph API and updates the local record.

        - Allowed statuses: approved, rejected, or disabled
        - Editable fields: category, components, time_to_live
        - Category cannot be changed for approved templates

        Returns the updated template on success.
      operationId: editWhatsappTemplateMeta
      tags:
        - WhatsApp Templates
      parameters:
        - name: template_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - template
              properties:
                template:
                  type: object
                  properties:
                    category:
                      type: string
                      enum: [MARKETING, UTILITY, AUTHENTICATION]
                      description: New template category. Cannot be changed when status is approved.
                    time_to_live:
                      type: integer
                      description: Optional TTL to apply in Meta (seconds).
                    components:
                      type: array
                      description: |
                        New template components to replace on Meta. If provided as an array,
                        the API will normalize it to Meta's canonical structure.
                      items:
                        type: object
                        properties:
                          type:
                            type: string
                            enum: [HEADER, BODY, FOOTER, BUTTONS]
                          format:
                            type: string
                            enum: [TEXT, IMAGE, VIDEO, DOCUMENT, LOCATION]
                          text:
                            type: string
                          example:
                            type: object
                          buttons:
                            type: array
                            items:
                              type: object
            examples:
              edit_components:
                summary: Replace BODY component text
                value:
                  template:
                    components:
                      - type: BODY
                        text: "Updated body text with {{1}} value"
                        example:
                          body_text:
                            - ["Example"]
              edit_category_rejected:
                summary: Change category on rejected template
                value:
                  template:
                    category: UTILITY
      responses:
        "200":
          description: Template edited successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/WhatsappTemplate"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Template not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "422":
          description: Validation error (e.g., cannot change category on approved template, invalid components)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Cannot edit the category of an approved template
                  errors:
                    type: array
                    items:
                      type: string
                    example:
                      - Invalid template component structure
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: error
                  message:
                    type: string
                    example: "Failed to edit template: Internal Error"
  /whatsapp_templates/sync:
    post:
      summary: Sync WhatsApp templates
      description: |
        Synchronize WhatsApp templates from Meta with the local database.

        **Sync Options:**
        - With `whatsapp_config_id`: Queue sync for that specific config
        - With `customer_id`: Queue sync for all production configs of that customer
        - With no parameters: Queue sync for all production configs in the project

        **Important Notes:**
        - Sync operations are grouped by WhatsApp Business Account ID
        - Only one active sync can run per Business Account at a time
        - If a sync is already running/queued for a Business Account, the existing sync request is returned
        - The sync operation is asynchronous and runs in the background
        - Use the sync_status endpoint to track progress

        **Response Structure:**
        The response includes an array of sync requests (one per Business Account) with:
        - Individual sync request details and status
        - Summary statistics (total requests, jobs enqueued, already in progress)
      operationId: syncWhatsappTemplates
      tags:
        - WhatsApp Templates
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                whatsapp_config_id:
                  type: string
                  format: uuid
                  description: Specific WhatsApp configuration to sync templates for
                  example: "550e8400-e29b-41d4-a716-446655440000"
                customer_id:
                  type: string
                  format: uuid
                  description: Customer ID to sync templates for all their production configs
                  example: "550e8400-e29b-41d4-a716-446655440001"
            examples:
              sync_specific_config:
                summary: Sync templates for specific config
                value:
                  whatsapp_config_id: "550e8400-e29b-41d4-a716-446655440000"
              sync_customer_configs:
                summary: Sync templates for all customer configs
                value:
                  customer_id: "550e8400-e29b-41d4-a716-446655440001"
              sync_all_configs:
                summary: Sync templates for all project configs
                value: {}
      responses:
        "202":
          description: Sync request accepted and queued
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "queued"
                    description: Overall status of the sync request
                  sync_requests:
                    type: array
                    description: Array of sync requests (one per Business Account)
                    items:
                      $ref: "#/components/schemas/WhatsappTemplateSyncRun"
                  summary:
                    type: object
                    description: Summary of sync operations
                    properties:
                      total_requests:
                        type: integer
                        description: Total number of sync requests created/found
                        example: 2
                      jobs_enqueued:
                        type: integer
                        description: Number of new sync jobs that were enqueued
                        example: 1
                      already_in_progress:
                        type: integer
                        description: Number of sync requests that were already running/queued
                        example: 1
              examples:
                new_sync:
                  summary: New sync request created
                  value:
                    status: "queued"
                    sync_requests:
                      - id: "sync-run-123abc"
                        business_account_id: "123456789012345"
                        anchor_whatsapp_config_id: "config-123abc"
                        status: "queued"
                        templates_synced: 0
                        templates_created: 0
                        templates_updated: 0
                        templates_removed: 0
                        queued_at: "2024-01-15T10:30:00Z"
                        started_at: null
                        finished_at: null
                        job_id: "job-456def"
                        error_class: null
                        error_message: null
                        results: {}
                        affected_whatsapp_config_ids: ["config-123abc"]
                        anchor_whatsapp_config:
                          id: "config-123abc"
                          name: "Main WhatsApp"
                          display_phone_number: "+1234567890"
                    summary:
                      total_requests: 1
                      jobs_enqueued: 1
                      already_in_progress: 0
                existing_sync:
                  summary: Sync already in progress
                  value:
                    status: "queued"
                    sync_requests:
                      - id: "sync-run-789ghi"
                        business_account_id: "123456789012345"
                        anchor_whatsapp_config_id: "config-456def"
                        status: "running"
                        templates_synced: 5
                        templates_created: 2
                        templates_updated: 2
                        templates_removed: 1
                        queued_at: "2024-01-15T10:25:00Z"
                        started_at: "2024-01-15T10:26:00Z"
                        finished_at: null
                        job_id: "job-789xyz"
                        results:
                          config-456def:
                            templates_synced: 5
                            templates_created: 2
                            templates_updated: 2
                            templates_removed: 1
                        affected_whatsapp_config_ids: ["config-456def"]
                    summary:
                      total_requests: 1
                      jobs_enqueued: 0
                      already_in_progress: 1
                multiple_business_accounts:
                  summary: Multiple Business Accounts synced
                  value:
                    status: "queued"
                    sync_requests:
                      - id: "sync-run-111aaa"
                        business_account_id: "111111111111111"
                        status: "queued"
                        templates_synced: 0
                        affected_whatsapp_config_ids: ["config-111", "config-222"]
                      - id: "sync-run-222bbb"
                        business_account_id: "222222222222222"
                        status: "running"
                        templates_synced: 3
                        affected_whatsapp_config_ids: ["config-333"]
                    summary:
                      total_requests: 2
                      jobs_enqueued: 1
                      already_in_progress: 1
        "401":
          description: Unauthorized - invalid or missing API key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: WhatsApp config or customer not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                config_not_found:
                  summary: WhatsApp config not found
                  value:
                    error: "Production WhatsApp configuration not found"
                customer_not_found:
                  summary: Customer not found
                  value:
                    error: "Customer not found"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                missing_business_account_id:
                  summary: Config missing business account ID
                  value:
                    error: "WhatsApp configuration missing business account id"
                    whatsapp_config_ids: ["config-123abc"]
                no_configs:
                  summary: No production configs available
                  value:
                    error: "No production WhatsApp configurations found"
  /whatsapp_templates/sync_status:
    get:
      summary: Get WhatsApp template sync status
      description: |
        Retrieve the status of WhatsApp template synchronization operations.

        **Filtering Options:**
        - By specific sync request IDs
        - By Business Account ID
        - By WhatsApp config ID (automatically resolves to Business Account)
        - By customer ID (finds all Business Accounts for customer's configs)

        **Default Behavior:**
        - Without filters: Returns the latest sync request per Business Account
        - With sync_request_ids: Returns those specific sync requests ordered by created_at desc

        **Response:**
        - Array of sync requests with their current status
        - Summary statistics including counts by status and last finished timestamp
      operationId: getWhatsappTemplateSyncStatus
      tags:
        - WhatsApp Templates
      parameters:
        - name: sync_request_ids
          in: query
          description: Filter by specific sync request IDs (comma-separated)
          schema:
            type: array
            items:
              type: string
              format: uuid
          style: form
          explode: false
          example: ["sync-run-123abc", "sync-run-456def"]
        - name: business_account_id
          in: query
          description: Filter by WhatsApp Business Account ID
          schema:
            type: string
          example: "123456789012345"
        - name: whatsapp_config_id
          in: query
          description: Filter by WhatsApp config ID (automatically resolves to Business Account)
          schema:
            type: string
            format: uuid
          example: "config-123abc"
        - name: customer_id
          in: query
          description: Filter by customer ID (finds all Business Accounts for customer's production configs)
          schema:
            type: string
            format: uuid
          example: "customer-456def"
      responses:
        "200":
          description: Sync status retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  sync_requests:
                    type: array
                    description: Array of sync requests matching the filters
                    items:
                      $ref: "#/components/schemas/WhatsappTemplateSyncRun"
                  summary:
                    type: object
                    description: Summary statistics of sync requests
                    properties:
                      total_requests:
                        type: integer
                        description: Total number of sync requests returned
                        example: 3
                      queued:
                        type: integer
                        description: Number of sync requests in queued state
                        example: 1
                      running:
                        type: integer
                        description: Number of sync requests currently running
                        example: 1
                      succeeded:
                        type: integer
                        description: Number of sync requests that succeeded
                        example: 1
                      failed:
                        type: integer
                        description: Number of sync requests that failed
                        example: 0
                      last_finished_at:
                        type: string
                        format: date-time
                        nullable: true
                        description: ISO 8601 timestamp of the most recent finished sync
                        example: "2024-01-15T10:45:00Z"
                      templates_removed:
                        type: integer
                        description: Total number of templates removed across all sync requests
                        example: 5
              examples:
                mixed_status:
                  summary: Multiple sync requests with different statuses
                  value:
                    sync_requests:
                      - id: "sync-run-123abc"
                        business_account_id: "111111111111111"
                        status: "succeeded"
                        templates_synced: 15
                        templates_created: 5
                        templates_updated: 8
                        templates_removed: 2
                        queued_at: "2024-01-15T10:00:00Z"
                        started_at: "2024-01-15T10:01:00Z"
                        finished_at: "2024-01-15T10:05:00Z"
                        affected_whatsapp_config_ids: ["config-111", "config-222"]
                      - id: "sync-run-456def"
                        business_account_id: "222222222222222"
                        status: "running"
                        templates_synced: 8
                        templates_created: 3
                        templates_updated: 4
                        templates_removed: 1
                        queued_at: "2024-01-15T10:15:00Z"
                        started_at: "2024-01-15T10:16:00Z"
                        finished_at: null
                        affected_whatsapp_config_ids: ["config-333"]
                      - id: "sync-run-789ghi"
                        business_account_id: "333333333333333"
                        status: "queued"
                        templates_synced: 0
                        templates_created: 0
                        templates_updated: 0
                        templates_removed: 0
                        queued_at: "2024-01-15T10:30:00Z"
                        started_at: null
                        finished_at: null
                        affected_whatsapp_config_ids: ["config-444"]
                    summary:
                      total_requests: 3
                      queued: 1
                      running: 1
                      succeeded: 1
                      failed: 0
                      last_finished_at: "2024-01-15T10:05:00Z"
                      templates_removed: 3
                failed_sync:
                  summary: Failed sync request
                  value:
                    sync_requests:
                      - id: "sync-run-failed"
                        business_account_id: "111111111111111"
                        status: "failed"
                        templates_synced: 3
                        templates_created: 1
                        templates_updated: 2
                        templates_removed: 0
                        queued_at: "2024-01-15T09:00:00Z"
                        started_at: "2024-01-15T09:01:00Z"
                        finished_at: "2024-01-15T09:02:00Z"
                        error_class: "WhatsappApiError"
                        error_message: "Invalid access token"
                        affected_whatsapp_config_ids: ["config-111"]
                    summary:
                      total_requests: 1
                      queued: 0
                      running: 0
                      succeeded: 0
                      failed: 1
                      last_finished_at: "2024-01-15T09:02:00Z"
                      templates_removed: 0
                no_syncs:
                  summary: No sync requests found
                  value:
                    sync_requests: []
                    summary:
                      total_requests: 0
                      queued: 0
                      running: 0
                      succeeded: 0
                      failed: 0
                      last_finished_at: null
                      templates_removed: 0
        "401":
          description: Unauthorized - invalid or missing API key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: WhatsApp config or customer not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                config_not_found:
                  summary: WhatsApp config not found
                  value:
                    error: "WhatsApp configuration not found"
                customer_not_found:
                  summary: Customer not found
                  value:
                    error: "Customer not found"
  /whatsapp_contacts:
    get:
      summary: List WhatsApp contacts
      description: Retrieve a paginated list of WhatsApp contacts for the project
      operationId: listWhatsappContacts
      tags:
        - WhatsApp Contacts
      security:
        - ApiKeyAuth: []
      parameters:
        - name: page
          in: query
          description: Page number
          required: false
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          description: Items per page
          required: false
          schema:
            type: integer
            default: 20
        - name: q[customer_id_eq]
          in: query
          description: Filter by exact customer ID match
          required: false
          schema:
            type: string
            format: uuid
          example: 123e4567-e89b-12d3-a456-426614174000
        - name: q[customer_external_customer_id_eq]
          in: query
          description: Filter by customer's external ID from your system
          required: false
          schema:
            type: string
          example: CUS-12345
        - name: q[customer_id_null]
          in: query
          description: Filter sandbox contacts (contacts with no customer assigned)
          required: false
          schema:
            type: boolean
          example: true
        - name: q[customer_id_not_null]
          in: query
          description: Filter contacts with customer assigned (non-sandbox)
          required: false
          schema:
            type: boolean
          example: true
        - name: q[profile_name_cont]
          in: query
          description: Filter by profile name contains (case insensitive partial match)
          required: false
          schema:
            type: string
          example: john
        - name: q[wa_id_cont]
          in: query
          description: Filter by phone number contains (partial match)
          required: false
          schema:
            type: string
          example: 555
        - name: q[created_at_gteq]
          in: query
          description: Filter by created date greater than or equal to (ISO 8601 format)
          required: false
          schema:
            type: string
            format: date-time
          example: 2024-01-01T00:00:00Z
        - name: q[created_at_lteq]
          in: query
          description: Filter by created date less than or equal to (ISO 8601 format)
          required: false
          schema:
            type: string
            format: date-time
          example: 2024-12-31T23:59:59Z
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/WhatsappContact"
                  meta:
                    $ref: "#/components/schemas/PaginationMeta"
              examples:
                all_contacts:
                  summary: All contacts
                  description: Returns all contacts when no filters are applied
                  value:
                    data:
                      - id: contact-789ghi
                        wa_id: "1234567890"
                        profile_name: John Doe
                        metadata: {}
                        created_at: "2024-01-15T10:30:00Z"
                        updated_at: "2024-01-15T10:30:00Z"
                      - id: contact-456def
                        wa_id: "0987654321"
                        profile_name: Jane Smith
                        metadata: {}
                        created_at: "2024-01-14T15:45:00Z"
                        updated_at: "2024-01-14T15:45:00Z"
                    meta:
                      page: 1
                      per_page: 20
                      total_pages: 1
                      total_count: 2
                customer_contacts:
                  summary: Customer's contacts
                  description: Returns contacts filtered by customer ID using q[customer_id_eq]=uuid
                  value:
                    data:
                      - id: contact-789ghi
                        wa_id: "1234567890"
                        profile_name: John Doe
                        metadata:
                          customer_type: premium
                        created_at: "2024-01-15T10:30:00Z"
                        updated_at: "2024-01-15T10:30:00Z"
                    meta:
                      page: 1
                      per_page: 20
                      total_pages: 1
                      total_count: 1
                sandbox_contacts:
                  summary: Sandbox contacts
                  description: Returns sandbox contacts (no customer) using q[customer_id_null]=true
                  value:
                    data:
                      - id: contact-sandbox-123
                        wa_id: "5555555555"
                        profile_name: Test User
                        metadata:
                          source: sandbox
                        created_at: "2024-01-16T09:20:00Z"
                        updated_at: "2024-01-16T09:20:00Z"
                    meta:
                      page: 1
                      per_page: 20
                      total_pages: 1
                      total_count: 1
                name_search:
                  summary: Name search
                  description: Returns contacts matching profile name using q[profile_name_cont]=john
                  value:
                    data:
                      - id: contact-789ghi
                        wa_id: "1234567890"
                        profile_name: John Doe
                        metadata: {}
                        created_at: "2024-01-15T10:30:00Z"
                        updated_at: "2024-01-15T10:30:00Z"
                      - id: contact-111aaa
                        wa_id: "1111111111"
                        profile_name: Johnny Smith
                        metadata: {}
                        created_at: "2024-01-13T11:15:00Z"
                        updated_at: "2024-01-13T11:15:00Z"
                    meta:
                      page: 1
                      per_page: 20
                      total_pages: 1
                      total_count: 2
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      summary: Create a WhatsApp contact
      description: Create a new WhatsApp contact for the project
      operationId: createWhatsappContact
      tags:
        - WhatsApp Contacts
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - contact
              properties:
                contact:
                  type: object
                  required:
                    - wa_id
                  properties:
                    wa_id:
                      type: string
                      example: "1234567890"
                      description: The WhatsApp phone number
                    profile_name:
                      type: string
                      example: John Doe
                    customer_id:
                      type: string
                      format: uuid
                      example: customer-456def
                      description: Optional customer ID to associate with this contact
                    metadata:
                      type: object
                      example:
                        source: website
                        tags:
                          - lead
                          - priority
      responses:
        "201":
          description: Contact created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/WhatsappContact"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                type: object
                properties:
                  errors:
                    type: array
                    items:
                      type: string
                    example:
                      - Wa_id has already been taken
  /whatsapp_contacts/{identifier}:
    get:
      summary: Get a WhatsApp contact
      description: Retrieve a specific WhatsApp contact by ID or phone number
      operationId: getWhatsappContact
      tags:
        - WhatsApp Contacts
      security:
        - ApiKeyAuth: []
      parameters:
        - name: identifier
          in: path
          required: true
          description: Contact ID (UUID) or phone number
          schema:
            type: string
            example: contact-789ghi or 1234567890
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/WhatsappContact"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Contact not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    patch:
      summary: Update a WhatsApp contact
      description: Update a WhatsApp contact's profile name and metadata
      operationId: updateWhatsappContact
      tags:
        - WhatsApp Contacts
      security:
        - ApiKeyAuth: []
      parameters:
        - name: identifier
          in: path
          required: true
          description: Contact ID (UUID) or phone number
          schema:
            type: string
            example: contact-789ghi or 1234567890
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                contact:
                  type: object
                  properties:
                    profile_name:
                      type: string
                      example: John Doe - VIP Customer
                    metadata:
                      type: object
                      example:
                        vip: true
                        subscription_tier: premium
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/WhatsappContact"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Contact not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /whatsapp_contacts/{identifier}/notes:
    get:
      summary: List notes for a WhatsApp contact
      description: Retrieve all notes for a specific WhatsApp contact
      operationId: listWhatsappContactNotes
      tags:
        - WhatsApp Contact Notes
      security:
        - ApiKeyAuth: []
      parameters:
        - name: identifier
          in: path
          required: true
          description: Contact ID (UUID) or phone number
          schema:
            type: string
            example: contact-789ghi or 1234567890
        - name: page
          in: query
          description: Page number
          required: false
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          description: Items per page
          required: false
          schema:
            type: integer
            default: 20
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/WhatsappContactNote"
                  meta:
                    $ref: "#/components/schemas/PaginationMeta"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Contact not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      summary: Create a note for a WhatsApp contact
      description: Create a new note for a specific WhatsApp contact
      operationId: createWhatsappContactNote
      tags:
        - WhatsApp Contact Notes
      security:
        - ApiKeyAuth: []
      parameters:
        - name: identifier
          in: path
          required: true
          description: Contact ID (UUID) or phone number
          schema:
            type: string
            example: contact-789ghi or 1234567890
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - note
              properties:
                note:
                  type: object
                  required:
                    - content
                  properties:
                    name:
                      type: string
                      description: Optional name for the note
                      example: Customer Preference
                    content:
                      type: string
                      description: The content of the note
                      example: Prefers morning deliveries between 9-11 AM
                    metadata:
                      type: object
                      description: Additional metadata
      responses:
        "201":
          description: Note created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/WhatsappContactNote"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Contact not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /whatsapp_contacts/{identifier}/notes/{note_id}:
    get:
      summary: Get a specific note
      description: Retrieve a specific note for a WhatsApp contact
      operationId: getWhatsappContactNote
      tags:
        - WhatsApp Contact Notes
      security:
        - ApiKeyAuth: []
      parameters:
        - name: identifier
          in: path
          required: true
          description: Contact ID (UUID) or phone number
          schema:
            type: string
            example: contact-789ghi or 1234567890
        - name: note_id
          in: path
          required: true
          description: Note ID
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/WhatsappContactNote"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Contact or note not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    patch:
      summary: Update a note
      description: Update a specific note for a WhatsApp contact
      operationId: updateWhatsappContactNote
      tags:
        - WhatsApp Contact Notes
      security:
        - ApiKeyAuth: []
      parameters:
        - name: identifier
          in: path
          required: true
          description: Contact ID (UUID) or phone number
          schema:
            type: string
            example: contact-789ghi or 1234567890
        - name: note_id
          in: path
          required: true
          description: Note ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                note:
                  type: object
                  properties:
                    name:
                      type: string
                      description: Optional name for the note
                    content:
                      type: string
                      description: The content of the note
                    metadata:
                      type: object
                      description: Additional metadata
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/WhatsappContactNote"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Contact or note not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      summary: Delete a note
      description: Delete a specific note for a WhatsApp contact
      operationId: deleteWhatsappContactNote
      tags:
        - WhatsApp Contact Notes
      security:
        - ApiKeyAuth: []
      parameters:
        - name: identifier
          in: path
          required: true
          description: Contact ID (UUID) or phone number
          schema:
            type: string
            example: contact-789ghi or 1234567890
        - name: note_id
          in: path
          required: true
          description: Note ID
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Note deleted successfully
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Contact or note not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /whatsapp_configs:
    get:
      summary: List WhatsApp configs
      description: |
        Returns a list of WhatsApp configurations available to the project.

        Results are scoped to configurations accessible by the API key's project.
      operationId: listWhatsappConfigs
      tags:
        - WhatsApp Configs
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: business_account_id
          in: query
          description: Filter by WhatsApp Business Account ID
          schema:
            type: string
          example: "123456789012345"
        - name: q[business_account_id_eq]
          in: query
          description: Filter by exact WhatsApp Business Account ID (Ransack syntax)
          schema:
            type: string
          example: "123456789012345"
        - name: q[name_cont]
          in: query
          description: Filter by name containing string
          schema:
            type: string
        - name: q[created_at_gteq]
          in: query
          description: Filter by created date >= (ISO 8601 format)
          schema:
            type: string
            format: date-time
        - name: q[created_at_lteq]
          in: query
          description: Filter by created date <= (ISO 8601 format)
          schema:
            type: string
            format: date-time
      responses:
        "200":
          description: List of WhatsApp configurations
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/WhatsappConfig"
                  meta:
                    $ref: "#/components/schemas/PaginationMeta"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /whatsapp_configs/{id}:
    get:
      summary: Get WhatsApp config details
      description: Returns details for a specific WhatsApp configuration
      operationId: getWhatsappConfigDetails
      tags:
        - WhatsApp Configs
      parameters:
        - name: id
          in: path
          required: true
          description: WhatsApp config ID
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: WhatsApp configuration details
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/WhatsappConfig"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: WhatsApp configuration not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    patch:
      summary: Update WhatsApp config
      description: Updates a WhatsApp configuration's details
      operationId: updateWhatsappConfigDetails
      tags:
        - WhatsApp Configs
      parameters:
        - name: id
          in: path
          required: true
          description: WhatsApp config ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - whatsapp_config
              properties:
                whatsapp_config:
                  type: object
                  properties:
                    name:
                      type: string
                      description: Configuration name
                    phone_number_id:
                      type: string
                      description: WhatsApp phone number ID
                    business_account_id:
                      type: string
                      description: WhatsApp Business Account ID
                    webhook_verify_token:
                      type: string
                      description: Token for webhook verification (write-only, not returned in responses)
                    webhook_destination_url:
                      type: string
                      description: URL for webhook delivery (write-only, not returned in responses)
                    access_token:
                      type: string
                      description: WhatsApp API access token
      responses:
        "200":
          description: WhatsApp configuration updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/WhatsappConfig"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: WhatsApp configuration not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "422":
          description: Validation errors
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      summary: Delete WhatsApp config
      description: Deletes a WhatsApp configuration
      operationId: deleteWhatsappConfigDetails
      tags:
        - WhatsApp Configs
      parameters:
        - name: id
          in: path
          required: true
          description: WhatsApp config ID
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: WhatsApp configuration deleted
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: WhatsApp configuration not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /whatsapp_configs/{id}/health:
    get:
      summary: Get WhatsApp config health status
      description: |
        Performs a comprehensive health check on a WhatsApp configuration to verify its operational status.

        **Health Checks Performed:**
        - Phone number access verification
        - Messaging health status (ability to send messages)
        - Webhook subscription status
        - Webhook verification status

        **Response Status:**
        - `healthy`: All checks pass
        - `degraded`: Some non-critical checks fail (e.g., webhook issues)
        - `unhealthy`: Critical checks fail (e.g., phone number access, token validity)
        - `error`: Service error occurred during health check

        **Note:** Test message sending is disabled by default for performance reasons.
      operationId: getWhatsappConfigHealthDetails
      tags:
        - WhatsApp Configs
      parameters:
        - name: id
          in: path
          required: true
          description: ID of the WhatsApp configuration to check
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Health check completed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy, degraded, unhealthy, error]
                    description: Overall health status
                  checks:
                    type: object
                    description: Individual health check results
                    properties:
                      phone_number_access:
                        type: object
                        properties:
                          passed:
                            type: boolean
                          details:
                            type: object
                          error:
                            type: string
                      messaging_health:
                        type: object
                        properties:
                          passed:
                            type: boolean
                          overall_status:
                            type: string
                          details:
                            type: object
                      webhook_subscription:
                        type: object
                        properties:
                          passed:
                            type: boolean
                          details:
                            type: object
                          error:
                            type: string
                      webhook_verified:
                        type: object
                        properties:
                          passed:
                            type: boolean
                          details:
                            type: object
                  timestamp:
                    type: string
                    format: date-time
                    description: When the health check was performed
                  error:
                    type: string
                    description: Error message if overall health check failed
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: WhatsApp configuration not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /whatsapp_calls:
    get:
      summary: List WhatsApp calls
      description: Returns a list of WhatsApp calls with optional filtering
      operationId: listWhatsappCalls
      tags:
        - WhatsApp Calls
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: status
          in: query
          description: Filter by call status
          schema:
            type: string
        - name: direction
          in: query
          description: Filter by call direction
          schema:
            type: string
            enum:
              - inbound
              - outbound
        - name: voice_agent_id
          in: query
          description: Filter by voice agent ID
          schema:
            type: string
            format: uuid
        - name: whatsapp_config_id
          in: query
          description: Filter by WhatsApp configuration ID
          schema:
            type: string
            format: uuid
        - name: period
          in: query
          description: Filter by time period
          schema:
            type: string
            enum:
              - today
              - week
              - month
              - custom
        - name: start_date
          in: query
          description: Start date for custom period (ISO 8601 format)
          schema:
            type: string
            format: date-time
        - name: end_date
          in: query
          description: End date for custom period (ISO 8601 format)
          schema:
            type: string
            format: date-time
      responses:
        "200":
          description: A list of WhatsApp calls
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/WhatsappCall"
                  meta:
                    $ref: "#/components/schemas/PaginationMeta"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /whatsapp_calls/{id}:
    get:
      summary: Get WhatsApp call details
      description: Returns details for a specific WhatsApp call
      operationId: getWhatsappCall
      tags:
        - WhatsApp Calls
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: WhatsApp call details
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/WhatsappCall"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Call not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                not_found:
                  summary: Call not found
                  value:
                    error: "Call not found"
  /whatsapp_contacts/{identifier}/call_permissions:
    get:
      summary: List call permissions for a WhatsApp contact
      description: |
        Returns all call permissions for a specific WhatsApp contact.
        The contact can be identified by either UUID or phone number (wa_id).
      operationId: listWhatsappContactCallPermissions
      tags:
        - WhatsApp Contact Call Permissions
      parameters:
        - name: identifier
          in: path
          required: true
          description: Contact UUID or phone number (will be normalized)
          schema:
            type: string
          examples:
            uuid:
              summary: Contact UUID
              value: "123e4567-e89b-12d3-a456-426614174000"
            phone:
              summary: Phone number
              value: "+1234567890"
      responses:
        "200":
          description: A list of call permissions
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/WhatsappContactCallPermission"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: WhatsApp contact not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                not_found:
                  summary: Contact not found
                  value:
                    error: "WhatsApp contact not found"
  /whatsapp_contacts/{identifier}/call_permissions/{whatsapp_config_id}:
    get:
      summary: Get specific call permission
      description: |
        Returns a specific call permission for a WhatsApp contact and configuration.
        The contact can be identified by either UUID or phone number (wa_id).
      operationId: getWhatsappContactCallPermission
      tags:
        - WhatsApp Contact Call Permissions
      parameters:
        - name: identifier
          in: path
          required: true
          description: Contact UUID or phone number (will be normalized)
          schema:
            type: string
          examples:
            uuid:
              summary: Contact UUID
              value: "123e4567-e89b-12d3-a456-426614174000"
            phone:
              summary: Phone number
              value: "+1234567890"
        - name: whatsapp_config_id
          in: path
          required: true
          description: WhatsApp configuration ID
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Call permission details
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/WhatsappContactCallPermission"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Contact or call permission not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                permission_not_found:
                  summary: Permission not found
                  value:
                    error: "Call permission not found"
                contact_not_found:
                  summary: Contact not found
                  value:
                    error: "WhatsApp contact not found"
